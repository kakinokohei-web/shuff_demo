<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>SHUFF v5.0</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1e293b; }
    input, select, textarea { font-size: 16px; }
    /* ãƒ¢ãƒã‚¤ãƒ«ã‚¿ãƒƒãƒæ”¹å–„ï¼š300msé…å»¶ã‚’ç„¡åŠ¹åŒ– */
    button, a, [role="button"] {
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    // ============================================
    // Supabaseè¨­å®šï¼ˆãƒ‡ãƒ¢ç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰
    // ============================================
    const SUPABASE_URL = 'https://jvgvnarwegqtqgpmhgdk.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_u4o0lNeGwiWM9OOABA6GjA_T8S336uk';

    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    const supabase = {
      from: (table) => {
        const query = `${SUPABASE_URL}/rest/v1/${table}`;
        const headers = {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
        };
        return {
          select: (columns = '*') => {
            let filters = [];
            let isSingle = false;
            const builder = {
              eq: (column, value) => {
                filters.push(`${column}=eq.${value}`);
                return builder;
              },
              single: () => {
                isSingle = true;
                return builder;
              },
              then: async (resolve, reject) => {
                try {
                  const filterStr = filters.length > 0 ? `&${filters.join('&')}` : '';
                  const res = await fetch(`${query}?select=${columns}${filterStr}`, { headers });
                  if (!res.ok) throw new Error(`HTTP ${res.status}`);
                  const data = await res.json();
                  if (isSingle) {
                    resolve({ data: Array.isArray(data) && data.length > 0 ? data[0] : null, error: null });
                  } else {
                    resolve({ data: Array.isArray(data) ? data : [], error: null });
                  }
                } catch (err) {
                  resolve({ data: isSingle ? null : [], error: err.message });
                }
              }
            };
            return builder;
          },
          insert: async (rows) => {
            try {
              console.log('[INSERT]', table, rows);
              const res = await fetch(query, {
                method: 'POST',
                headers: { ...headers, 'Prefer': 'return=representation' },
                body: JSON.stringify(rows),
              });
              if (!res.ok) {
                const errorText = await res.text();
                console.error('[INSERT ERROR]', res.status, errorText);
                throw new Error(`HTTP ${res.status}: ${errorText}`);
              }
              const data = await res.json();
              return { data: Array.isArray(data) ? data : [], error: null };
            } catch (err) {
              return { data: [], error: err.message };
            }
          },
          update: (updates) => ({
            eq: async (column, value) => {
              try {
                const res = await fetch(`${query}?${column}=eq.${value}`, {
                  method: 'PATCH',
                  headers: { ...headers, 'Prefer': 'return=representation' },
                  body: JSON.stringify(updates),
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                return { data: Array.isArray(data) ? data : [], error: null };
              } catch (err) {
                return { data: [], error: err.message };
              }
            },
          }),
          delete: () => ({
            eq: async (column, value) => {
              try {
                const res = await fetch(`${query}?${column}=eq.${value}`, { method: 'DELETE', headers });
                return { error: res.ok ? null : 'Delete failed' };
              } catch (err) {
                return { error: err.message };
              }
            },
          }),
          upsert: async (rows) => {
            try {
              const res = await fetch(query, {
                method: 'POST',
                headers: { ...headers, 'Prefer': 'return=representation,resolution=merge-duplicates' },
                body: JSON.stringify(rows),
              });
              if (!res.ok) throw new Error(`HTTP ${res.status}`);
              const data = await res.json();
              return { data: Array.isArray(data) ? data : [], error: null };
            } catch (err) {
              return { data: [], error: err.message };
            }
          },
        };
      },
    };

    // ============================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ============================================
    const getStatusColor = (status) => {
      switch (status) {
        case 'VIP': return 'bg-yellow-500';
        case 'å¸¸é€£': return 'bg-blue-500';
        case 'æ–°è¦': return 'bg-green-500';
        default: return 'bg-gray-500';
      }
    };

    const getStatusBgLight = (status) => {
      switch (status) {
        case 'VIP': return 'bg-yellow-100 border-yellow-400';
        case 'å¸¸é€£': return 'bg-blue-100 border-blue-400';
        case 'æ–°è¦': return 'bg-green-100 border-green-400';
        default: return 'bg-gray-100 border-gray-400';
      }
    };

    const formatTime = (dateString) => {
      if (!dateString) return '-';
      return new Date(dateString).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    };

    const formatDateFull = (dateString) => {
      if (!dateString) return '-';
      const d = new Date(dateString);
      const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      return `${d.getMonth()+1}/${d.getDate()}(${days[d.getDay()]})`;
    };

    // ============================================
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼
    // ============================================
    const NavBar = ({ currentPage, onNavigate }) => {
      const tabs = [
        { id: 'floor', icon: 'ğŸª‘', label: 'ãƒ•ãƒ­ã‚¢' },
        { id: 'dashboard', icon: 'ğŸ“Š', label: 'å£²ä¸Š' },
        { id: 'staff', icon: 'ğŸ¥‚', label: 'ã‚¹ã‚¿ãƒ‰ãƒª' },
        { id: 'shift', icon: 'ğŸ“…', label: 'ã‚·ãƒ•ãƒˆ' },
        { id: 'customers', icon: 'ğŸ‘¥', label: 'é¡§å®¢' },
        { id: 'settings', icon: 'âš™ï¸', label: 'è¨­å®š' },
      ];
      return (
        <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-40">
          <div className="flex">
            {tabs.map(tab => (
              <button key={tab.id} onClick={() => onNavigate(tab.id)}
                className={`flex-1 py-2 text-center transition-colors flex flex-col items-center
                  ${currentPage === tab.id ? 'text-blue-600 bg-blue-50' : 'text-gray-500'}`}>
                <span className="text-lg">{tab.icon}</span>
                <span className="text-xs">{tab.label}</span>
              </button>
            ))}
          </div>
        </div>
      );
    };

    // ãƒãƒ£ãƒ¼ã‚¸è¨ˆç®—ï¼ˆÂ¥880/æ™‚é–“/äººï¼‰- ç€å¸­ã—ãŸæ™‚ç‚¹ã§1æ™‚é–“åˆ†ç™ºç”Ÿ
    const CHARGE_PER_HOUR = 880;
    const calculateCharge = (seatedAt, partySize = 1, currentTime = Date.now()) => {
      if (!seatedAt) return 0;
      const minutes = (currentTime - new Date(seatedAt).getTime()) / 60000;
      const hours = Math.floor(minutes / 60) + 1; // 0åˆ†=1æ™‚é–“åˆ†ã€61åˆ†=2æ™‚é–“åˆ†
      return hours * CHARGE_PER_HOUR * partySize;
    };

    // ============================================
    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆé‡‘é¡è¡¨ç¤ºä»˜ããƒ»ã‚°ãƒ«ãƒ¼ãƒ—å¯¾å¿œï¼‰
    // ============================================
    const CounterSeat = ({ seat, customer, visit, seatTotal, groupTotal, isPrimary, primarySeatId, groupColor, onSelect, currentTime }) => {
      // currentTimeãŒå¤‰ã‚ã‚‹ã¨å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã€çµŒéæ™‚é–“ãŒå†è¨ˆç®—ã•ã‚Œã‚‹
      const duration = visit?.seated_at ? Math.floor((currentTime - new Date(visit.seated_at).getTime()) / 60000) : 0;

      // ã‚°ãƒ«ãƒ¼ãƒ—è‰²ã®ãƒœãƒ¼ãƒ€ãƒ¼è¨­å®š
      const groupBorderColors = {
        purple: 'ring-4 ring-purple-400',
        pink: 'ring-4 ring-pink-400',
        cyan: 'ring-4 ring-cyan-400',
        orange: 'ring-4 ring-orange-400',
        lime: 'ring-4 ring-lime-400',
        amber: 'ring-4 ring-amber-400',
        teal: 'ring-4 ring-teal-400',
        rose: 'ring-4 ring-rose-400',
      };

      return (
        <button onClick={() => onSelect(seat)}
          className={`w-14 h-14 rounded-full flex flex-col items-center justify-center transition-all duration-200 border-2 shadow-sm
            ${groupColor ? groupBorderColors[groupColor] : ''}
            ${seat.occupied
              ? `${customer ? getStatusBgLight(customer.status) : 'bg-orange-100 border-orange-400'} active:scale-95`
              : 'bg-gray-100 border-gray-300 active:scale-95 active:bg-gray-200'}`}>
          <span className={`text-xs font-bold ${seat.occupied ? 'text-gray-700' : 'text-gray-400'}`}>
            {seat.id.replace('C', '')}
          </span>
          {seat.occupied && (
            <>
              <span className="text-[8px] text-gray-500">{duration}åˆ†</span>
              {isPrimary ? (
                <span className="text-[8px] font-bold text-green-600">Â¥{groupTotal.toLocaleString()}</span>
              ) : (
                <span className="text-[8px] text-gray-400">â†’{primarySeatId?.replace('C', '')}</span>
              )}
            </>
          )}
        </button>
      );
    };

    // ============================================
    // ãƒ†ãƒ¼ãƒ–ãƒ«å¸­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆé‡‘é¡è¡¨ç¤ºä»˜ããƒ»ã‚°ãƒ«ãƒ¼ãƒ—å¯¾å¿œï¼‰
    // ============================================
    const TableSeat = ({ seat, customer, visit, seatTotal, groupTotal, isPrimary, primarySeatId, groupColor, onSelect, currentTime }) => {
      // currentTimeãŒå¤‰ã‚ã‚‹ã¨å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã€çµŒéæ™‚é–“ãŒå†è¨ˆç®—ã•ã‚Œã‚‹
      const duration = visit?.seated_at ? Math.floor((currentTime - new Date(visit.seated_at).getTime()) / 60000) : 0;
      const partySize = visit?.party_size || 1;

      // ã‚°ãƒ«ãƒ¼ãƒ—è‰²ã®ãƒœãƒ¼ãƒ€ãƒ¼è¨­å®š
      const groupBorderColors = {
        purple: 'ring-4 ring-purple-400',
        pink: 'ring-4 ring-pink-400',
        cyan: 'ring-4 ring-cyan-400',
        orange: 'ring-4 ring-orange-400',
        lime: 'ring-4 ring-lime-400',
        amber: 'ring-4 ring-amber-400',
        teal: 'ring-4 ring-teal-400',
        rose: 'ring-4 ring-rose-400',
      };

      return (
        <button onClick={() => onSelect(seat)}
          className={`w-28 h-24 rounded-xl flex flex-col items-center justify-center transition-all duration-200 border-2 shadow-md
            ${groupColor ? groupBorderColors[groupColor] : ''}
            ${seat.occupied
              ? `${customer ? getStatusBgLight(customer.status) : 'bg-orange-100 border-orange-400'} active:scale-95`
              : 'bg-gray-100 border-gray-300 active:scale-95 active:bg-gray-200'}`}>
          <span className={`text-sm font-bold ${seat.occupied ? 'text-gray-700' : 'text-gray-400'}`}>
            {seat.id}
          </span>
          {seat.occupied ? (
            <>
              {customer && <span className="text-xs text-gray-600 truncate w-full px-1 text-center">{customer.name.substring(0,4)}</span>}
              <div className="flex items-center gap-1 text-[10px] text-gray-500">
                <span>{partySize}å</span>
                <span>{duration}åˆ†</span>
              </div>
              {isPrimary ? (
                <span className="text-xs font-bold text-green-600">Â¥{groupTotal.toLocaleString()}</span>
              ) : (
                <span className="text-xs text-gray-400">â†’{primarySeatId}</span>
              )}
            </>
          ) : (
            <span className="text-xs text-gray-400">ç©ºå¸­</span>
          )}
        </button>
      );
    };

    // ============================================
    // é¡§å®¢ã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆ
    // ============================================
    const CustomerAutocomplete = ({ customers, onSelect, onCreateNew }) => {
      const [search, setSearch] = useState('');
      const [showSuggestions, setShowSuggestions] = useState(false);

      const filtered = useMemo(() => {
        if (!search.trim()) return [];
        const s = search.toLowerCase();
        return customers.filter(c =>
          c.name.toLowerCase().includes(s) ||
          (c.name_kana && c.name_kana.toLowerCase().includes(s)) ||
          (c.favorite && c.favorite.toLowerCase().includes(s)) ||
          (c.appearance && c.appearance.toLowerCase().includes(s))
        ).slice(0, 5);
      }, [search, customers]);

      return (
        <div className="relative">
          <input type="text" value={search}
            onChange={(e) => { setSearch(e.target.value); setShowSuggestions(true); }}
            onFocus={() => setShowSuggestions(true)}
            className="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:outline-none focus:border-blue-500"
            placeholder="åå‰ãƒ»ç‰¹å¾´ã§æ¤œç´¢..." />
          {showSuggestions && search && (
            <div className="absolute top-full left-0 right-0 bg-white border rounded-xl shadow-lg mt-1 z-50 max-h-60 overflow-y-auto">
              {filtered.map(customer => (
                <button key={customer.id}
                  onClick={() => { onSelect(customer); setSearch(''); setShowSuggestions(false); }}
                  className="w-full text-left p-3 hover:bg-gray-50 active:bg-gray-100 border-b last:border-0">
                  <div className="flex justify-between items-center">
                    <div>
                      <div className="font-semibold">{customer.name}</div>
                      <div className="text-xs text-gray-500">{customer.appearance || customer.favorite || 'æƒ…å ±ãªã—'}</div>
                    </div>
                    <span className={`px-2 py-1 rounded-full text-xs text-white ${getStatusColor(customer.status)}`}>{customer.status}</span>
                  </div>
                </button>
              ))}
              {filtered.length === 0 && <div className="p-3 text-center text-gray-500">è©²å½“ãªã—</div>}
              <button onClick={() => { onCreateNew(search); setShowSuggestions(false); }}
                className="w-full p-3 text-center text-green-600 font-semibold hover:bg-green-50 border-t">
                ï¼‹ã€Œ{search}ã€ã‚’æ–°è¦ç™»éŒ²
              </button>
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // æ¥åº—äºˆæ¸¬ï¼ˆæ›œæ—¥ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
    // ============================================
    const getVisitPrediction = (customer) => {
      const today = new Date().getDay(); // 0=æ—¥, 1=æœˆ, ...
      const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
      const pattern = customer.visit_pattern || {};
      const todayCount = pattern[today] || 0;
      const totalVisits = customer.total_visits || 0;
      if (totalVisits < 2) return null;
      const probability = totalVisits > 0 ? Math.round((todayCount / totalVisits) * 100) : 0;
      if (probability >= 30) return { prob: probability, day: dayNames[today], high: true };
      if (probability >= 15) return { prob: probability, day: dayNames[today], high: false };
      return null;
    };

    // ============================================
    // æ–°è¦é¡§å®¢ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå¸¸é€£å„ªå…ˆãƒ»æ€§åˆ¥è¿½åŠ ãƒ»è¤‡æ•°å¸­å¯¾å¿œï¼‰
    // ============================================
    const NewCustomerModal = ({ seat, initialName, customers, allSeats, onClose, onSave, onSelectExisting }) => {
      const [mode, setMode] = useState('select'); // 'select', 'new'
      const [customerTab, setCustomerTab] = useState('regular'); // 'regular'ï¼ˆå¸¸é€£ï¼‰, 'free'ï¼ˆãƒ•ãƒªãƒ¼ï¼‰

      // ãƒ•ãƒªãƒ¼å®¢ç”¨ã®ãƒ€ãƒŸãƒ¼åã‚’ç”Ÿæˆï¼ˆè¥¿æš¦ä»˜ãï¼‰
      const generateDummyName = () => {
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${now.getMonth() + 1}/${now.getDate()}`;
        const timeStr = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
        return `${seat.id} (${dateStr} ${timeStr})`;
      };
      const [selectedCustomer, setSelectedCustomer] = useState(null);
      const [name, setName] = useState(initialName || '');
      const [nameKana, setNameKana] = useState('');
      const [gender, setGender] = useState('');
      const [status, setStatus] = useState('æ–°è¦');
      const [appearance, setAppearance] = useState('');
      const [ageRange, setAgeRange] = useState('');
      const [favorite, setFavorite] = useState('');
      const [notes, setNotes] = useState('');
      const [partySize, setPartySize] = useState('1');
      const [selectedSeats, setSelectedSeats] = useState([seat.id]); // è¤‡æ•°å¸­é¸æŠ
      const [saving, setSaving] = useState(false);
      const [searchText, setSearchText] = useState('');

      const isTable = seat.seat_type && seat.seat_type !== 'counter';
      const isCounter = !isTable;

      // å…¨ã¦ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­ï¼ˆC1ã€œC8ã®é †ç•ªã§è¡¨ç¤ºï¼‰
      const allCounterSeats = allSeats ? allSeats
        .filter(s => s.seat_type === 'counter')
        .sort((a, b) => {
          const numA = parseInt(a.id.replace('C', ''));
          const numB = parseInt(b.id.replace('C', ''));
          return numA - numB;
        }) : [];
      const ageOptions = ['', '10ä»£', '20ä»£å‰åŠ', '20ä»£å¾ŒåŠ', '30ä»£å‰åŠ', '30ä»£å¾ŒåŠ', '40ä»£', '50ä»£', '60ä»£ä»¥ä¸Š'];
      const genderOptions = ['', 'ç”·æ€§', 'å¥³æ€§', 'ãã®ä»–'];

      // é¡§å®¢ã‚½ãƒ¼ãƒˆï¼šç›´è¿‘æ¥åº—è€…å„ªå…ˆ â†’ åˆ©ç”¨é‡‘é¡é †ã§è£œå®Œ
      const sortedCustomers = useMemo(() => {
        // æ¥åº—å±¥æ­´ãŒã‚ã‚‹é¡§å®¢ï¼ˆç›´è¿‘é †ï¼‰
        const withVisit = customers
          .filter(c => c.last_visit_at)
          .sort((a, b) => new Date(b.last_visit_at) - new Date(a.last_visit_at));

        // æ¥åº—å±¥æ­´ãŒãªã„é¡§å®¢ï¼ˆåˆ©ç”¨é‡‘é¡é †ï¼‰
        const withoutVisit = customers
          .filter(c => !c.last_visit_at)
          .sort((a, b) => (b.total_spent || 0) - (a.total_spent || 0));

        // æ¥åº—å±¥æ­´ã‚ã‚Š â†’ æ¥åº—å±¥æ­´ãªã— ã®é †ã§çµåˆ
        return [...withVisit, ...withoutVisit];
      }, [customers]);

      // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
      const filteredCustomers = useMemo(() => {
        // æ¤œç´¢ãƒ†ã‚­ã‚¹ãƒˆãŒãªã„å ´åˆï¼šä¸Šä½10äººã‚’è¡¨ç¤º
        if (!searchText.trim()) {
          return sortedCustomers.slice(0, 10);
        }
        // æ¤œç´¢ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆï¼šå…¨é¡§å®¢ã‹ã‚‰æ¤œç´¢
        const s = searchText.toLowerCase();
        return customers.filter(c =>
          c.name.toLowerCase().includes(s) ||
          (c.name_kana && c.name_kana.toLowerCase().includes(s)) ||
          (c.favorite && c.favorite.toLowerCase().includes(s)) ||
          (c.appearance && c.appearance.toLowerCase().includes(s))
        ).slice(0, 20); // æ¤œç´¢æ™‚ã¯20ä»¶ã¾ã§è¡¨ç¤º
      }, [sortedCustomers, customers, searchText]);

      // äººæ•°å¤‰æ›´æ™‚ã«å¸­é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      const handlePartySizeChange = (size) => {
        setPartySize(size);
        if (isCounter && parseInt(size) > 1) {
          // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§2åä»¥ä¸Šã®å ´åˆã€æœ€åˆã®å¸­ã ã‘é¸æŠçŠ¶æ…‹ã«
          setSelectedSeats([seat.id]);
        }
      };

      // å¸­ã®é¸æŠåˆ‡ã‚Šæ›¿ãˆ
      const toggleSeatSelection = (seatId) => {
        const ps = parseInt(partySize) || 1;
        if (selectedSeats.includes(seatId)) {
          // æœ€åˆã®å¸­ï¼ˆã‚¿ãƒƒãƒ—ã—ãŸå¸­ï¼‰ã¯å¤–ã›ãªã„
          if (seatId === seat.id) return;
          setSelectedSeats(selectedSeats.filter(id => id !== seatId));
        } else {
          if (selectedSeats.length < ps) {
            setSelectedSeats([...selectedSeats, seatId]);
          }
        }
      };

      // æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²ã—ã¦ç€å¸­
      const handleSaveNew = async () => {
        if (!name.trim()) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        const ps = parseInt(partySize) || 1;
        if (isCounter && ps > 1 && selectedSeats.length !== ps) {
          alert(`${ps}åã®å ´åˆã€${ps}å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„`);
          return;
        }
        setSaving(true);
        await onSave({
          name,
          name_kana: nameKana,
          gender,
          status,
          appearance,
          age_range: ageRange,
          favorite,
          notes
        }, selectedSeats, ps);
        setSaving(false);
      };

      // æ—¢å­˜é¡§å®¢ã‚’ç€å¸­
      const handleSeatExisting = async () => {
        if (!selectedCustomer) return;
        const ps = parseInt(partySize) || 1;
        if (isCounter && ps > 1 && selectedSeats.length !== ps) {
          alert(`${ps}åã®å ´åˆã€${ps}å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„`);
          return;
        }
        setSaving(true);
        await onSelectExisting(selectedCustomer, selectedSeats, ps);
        setSaving(false);
      };

      // æ—¢å­˜é¡§å®¢ã‚’é¸æŠ
      const handleSelectCustomer = (customer) => {
        setSelectedCustomer(customer);
      };

      // ãƒ•ãƒªãƒ¼å®¢ã¨ã—ã¦ç€å¸­ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å€¤ã‚’ä½¿ç”¨ï¼‰
      const handleSeatFree = async () => {
        if (!name.trim()) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        const ps = parseInt(partySize) || 1;
        if (isCounter && ps > 1 && selectedSeats.length !== ps) {
          alert(`${ps}åã®å ´åˆã€${ps}å¸­ã‚’é¸æŠã—ã¦ãã ã•ã„`);
          return;
        }
        setSaving(true);
        await onSave({
          name,
          name_kana: nameKana,
          gender,
          status,
          appearance,
          age_range: ageRange,
          favorite,
          notes
        }, selectedSeats, ps);
        setSaving(false);
      };

      // ãƒ•ãƒªãƒ¼ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸã¨ãã«ãƒ€ãƒŸãƒ¼åã‚’ã‚»ãƒƒãƒˆ
      const handleTabChange = (tab) => {
        setCustomerTab(tab);
        if (tab === 'free') {
          setName(generateDummyName());
          // ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
          setNameKana('');
          setGender('');
          setStatus('æ–°è¦');
          setAppearance('');
          setAgeRange('');
          setFavorite('');
          setNotes('');
        } else {
          // å¸¸é€£ã‚¿ãƒ–ã«æˆ»ã‚‹æ™‚ã¯ãƒªã‚»ãƒƒãƒˆ
          setName(initialName || '');
        }
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl p-5 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-bold">ğŸ‘¤ {seat.id} ã«ç€å¸­</h2>
              <button onClick={onClose} className="text-gray-400 text-2xl">&times;</button>
            </div>

            {/* äººæ•°å…¥åŠ›ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ */}
            <div className="mb-4 bg-blue-50 p-3 rounded-xl">
              <label className="block text-sm font-semibold text-blue-700 mb-2">ğŸ‘¥ æ¥åº—äººæ•°</label>
              <div className="flex gap-2 flex-wrap">
                {[1,2,3,4,5,6,7,8].map(n => (
                  <button key={n} onClick={() => handlePartySizeChange(n.toString())}
                    className={`w-10 h-10 rounded-full font-bold ${partySize === n.toString() ? 'bg-blue-500 text-white' : 'bg-white border-2 border-gray-300'}`}>
                    {n}
                  </button>
                ))}
              </div>
            </div>

            {/* ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­ã§2åä»¥ä¸Šã®å ´åˆã€å¸­é¸æŠ */}
            {isCounter && parseInt(partySize) > 1 && (
              <div className="mb-4 bg-amber-50 p-3 rounded-xl">
                <label className="block text-sm font-semibold text-amber-700 mb-2">
                  ğŸª‘ å¸­ã‚’é¸æŠï¼ˆ{selectedSeats.length}/{partySize}å¸­ï¼‰
                </label>
                <div className="flex gap-1 justify-between">
                  {allCounterSeats.map(s => {
                    // å¸­ã®çŠ¶æ…‹ã‚’åˆ¤å®š
                    const isCurrentSeat = s.id === seat.id; // æœ€åˆã«ã‚¿ãƒƒãƒ—ã—ãŸå¸­
                    const isSelected = selectedSeats.includes(s.id); // é¸æŠæ¸ˆã¿
                    const isOccupied = s.occupied && !isCurrentSeat; // ä»–ã®äººãŒç€å¸­ä¸­

                    return (
                      <button
                        key={s.id}
                        onClick={() => !isOccupied && toggleSeatSelection(s.id)}
                        disabled={isOccupied}
                        className={`w-9 h-9 rounded-lg font-bold text-xs transition-all ${
                          isOccupied
                            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                            : isSelected
                              ? 'bg-amber-500 text-white'
                              : 'bg-white border-2 border-gray-300'
                        } ${isCurrentSeat ? 'ring-2 ring-amber-600' : ''}`}
                      >
                        {s.id}
                      </button>
                    );
                  })}
                </div>
                <p className="text-xs text-amber-600 mt-2">â€» æœ€åˆã«ã‚¿ãƒƒãƒ—ã—ãŸå¸­ {seat.id} ã¯é¸æŠæ¸ˆã¿</p>
              </div>
            )}

            {mode === 'select' ? (
              <>
                {/* å¸¸é€£/ãƒ•ãƒªãƒ¼ ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */}
                <div className="flex gap-2 mb-4">
                  <button
                    onClick={() => handleTabChange('regular')}
                    className={`flex-1 py-2 rounded-xl font-semibold text-sm transition-all ${
                      customerTab === 'regular'
                        ? 'bg-blue-500 text-white'
                        : 'bg-gray-100 text-gray-600'
                    }`}
                  >
                    ğŸ‘¥ å¸¸é€£
                  </button>
                  <button
                    onClick={() => handleTabChange('free')}
                    className={`flex-1 py-2 rounded-xl font-semibold text-sm transition-all ${
                      customerTab === 'free'
                        ? 'bg-green-500 text-white'
                        : 'bg-gray-100 text-gray-600'
                    }`}
                  >
                    ğŸ†“ ãƒ•ãƒªãƒ¼
                  </button>
                </div>

                {customerTab === 'regular' ? (
                  <>
                    {/* é¡§å®¢æ¤œç´¢ */}
                    <input type="text" value={searchText} onChange={(e) => setSearchText(e.target.value)}
                      className="w-full border-2 border-gray-200 rounded-xl px-4 py-3 mb-3 focus:outline-none focus:border-blue-500"
                      placeholder="ğŸ” åå‰ãƒ»ç‰¹å¾´ã§æ¤œç´¢..." />

                {/* æ—¢å­˜é¡§å®¢é¸æŠæ¸ˆã¿ */}
                {selectedCustomer && (
                  <div className="mb-3 bg-green-50 border-2 border-green-400 rounded-xl p-3">
                    <div className="flex justify-between items-center">
                      <div>
                        <p className="font-bold text-green-800">âœ“ {selectedCustomer.name}</p>
                        <p className="text-sm text-green-600">{selectedCustomer.favorite || selectedCustomer.appearance || ''}</p>
                      </div>
                      <button onClick={() => setSelectedCustomer(null)} className="text-green-600 text-sm">å¤‰æ›´</button>
                    </div>
                  </div>
                )}

                {/* å¸¸é€£ãƒªã‚¹ãƒˆï¼ˆæ¥åº—äºˆæ¸¬ä»˜ãï¼‰ */}
                {!selectedCustomer && (
                  <div className="max-h-64 overflow-y-auto mb-3 border rounded-xl">
                    {filteredCustomers.map(customer => {
                      const pred = getVisitPrediction(customer);
                      return (
                        <button key={customer.id}
                          onClick={() => handleSelectCustomer(customer)}
                          className="w-full text-left p-3 hover:bg-gray-50 active:bg-gray-100 border-b last:border-0 flex justify-between items-center">
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <span className="font-semibold">{customer.name}</span>
                              <span className={`px-2 py-0.5 rounded-full text-xs text-white ${getStatusColor(customer.status)}`}>
                                {customer.status}
                              </span>
                              {customer.gender && <span className="text-xs text-gray-400">{customer.gender}</span>}
                            </div>
                            <div className="text-xs text-gray-500">{customer.favorite || customer.appearance || 'æƒ…å ±ãªã—'}</div>
                          </div>
                          {pred && (
                            <div className={`text-xs px-2 py-1 rounded-full ${pred.high ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}`}>
                              {pred.day}æ›œ{pred.prob}%
                            </div>
                          )}
                        </button>
                      );
                    })}
                    {filteredCustomers.length === 0 && (
                      <p className="text-center text-gray-400 py-4">è©²å½“ã™ã‚‹é¡§å®¢ãŒã„ã¾ã›ã‚“</p>
                    )}
                  </div>
                )}

                    {/* ãƒœã‚¿ãƒ³ */}
                    <div className="space-y-2">
                      {selectedCustomer ? (
                        <button onClick={handleSeatExisting} disabled={saving}
                          className="w-full py-3 rounded-xl bg-green-500 text-white font-semibold active:bg-green-600 disabled:opacity-50">
                          {saving ? 'å‡¦ç†ä¸­...' : `${selectedCustomer.name}ã•ã‚“ã‚’ç€å¸­ï¼ˆ${partySize}å${isCounter && parseInt(partySize) > 1 ? ` / å¸­:${selectedSeats.join(',')}` : ''}ï¼‰`}
                        </button>
                      ) : null}
                      <button onClick={() => setMode('new')}
                        className="w-full py-3 rounded-xl border-2 border-blue-500 text-blue-500 font-semibold active:bg-blue-50">
                        ï¼‹ æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²
                      </button>
                      <button onClick={onClose}
                        className="w-full py-2 text-gray-500 text-sm">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                  </>
                ) : (
                  /* ãƒ•ãƒªãƒ¼ã‚¿ãƒ– - æ–°è¦é¡§å®¢ã¨åŒã˜ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåå‰ã«ãƒ€ãƒŸãƒ¼åãŒãƒ—ãƒªã‚»ãƒƒãƒˆï¼‰ */
                  <div className="space-y-3">
                    <div className="bg-green-50 border-2 border-green-200 rounded-xl p-2 text-center mb-2">
                      <p className="text-green-700 text-sm">ğŸ†“ ãƒ•ãƒªãƒ¼å®¢ - å¾Œã‹ã‚‰æƒ…å ±ã‚’ç·¨é›†ã§ãã¾ã™</p>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-1">åå‰ *</label>
                      <input type="text" value={name} onChange={(e) => setName(e.target.value)}
                        className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™" />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-1">ãµã‚ŠãŒãª</label>
                      <input type="text" value={nameKana} onChange={(e) => setNameKana(e.target.value)}
                        className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="ã‚„ã¾ã  ãŸã‚ã†" />
                    </div>
                    <div className="grid grid-cols-3 gap-2">
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">æ€§åˆ¥</label>
                        <select value={gender} onChange={(e) => setGender(e.target.value)}
                          className="w-full border-2 border-gray-200 rounded-xl px-2 py-2">
                          {genderOptions.map(g => <option key={g} value={g}>{g || 'é¸æŠ'}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <select value={status} onChange={(e) => setStatus(e.target.value)}
                          className="w-full border-2 border-gray-200 rounded-xl px-2 py-2">
                          <option value="æ–°è¦">æ–°è¦</option>
                          <option value="å¸¸é€£">å¸¸é€£</option>
                          <option value="VIP">VIP</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-gray-700 mb-1">å¹´ä»£</label>
                        <select value={ageRange} onChange={(e) => setAgeRange(e.target.value)}
                          className="w-full border-2 border-gray-200 rounded-xl px-2 py-2">
                          {ageOptions.map(a => <option key={a} value={a}>{a || 'é¸æŠ'}</option>)}
                        </select>
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-1">è¦‹ãŸç›®ãƒ»ç‰¹å¾´</label>
                      <input type="text" value={appearance} onChange={(e) => setAppearance(e.target.value)}
                        className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="ãƒ¡ã‚¬ãƒã€é•·é«ª..." />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-1">å¥½ã¿ã®ãƒ‰ãƒªãƒ³ã‚¯</label>
                      <input type="text" value={favorite} onChange={(e) => setFavorite(e.target.value)}
                        className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="ãƒã‚¤ãƒœãƒ¼ãƒ«è–„ã‚" />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-1">ãƒ¡ãƒ¢</label>
                      <textarea value={notes} onChange={(e) => setNotes(e.target.value)}
                        className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" rows={2} placeholder="è©±é¡Œã€æ³¨æ„ç‚¹" />
                    </div>
                    <div className="flex gap-3 mt-3">
                      <button onClick={onClose} className="flex-1 py-3 rounded-xl border-2 border-gray-300 font-semibold">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                      </button>
                      <button onClick={handleSeatFree} disabled={saving || !name.trim() || (isCounter && parseInt(partySize) > 1 && selectedSeats.length !== parseInt(partySize))}
                        className="flex-1 py-3 rounded-xl bg-green-500 text-white font-semibold disabled:opacity-50">
                        {saving ? 'å‡¦ç†ä¸­...' : `ãƒ•ãƒªãƒ¼ã§ç€å¸­ï¼ˆ${partySize}åï¼‰`}
                      </button>
                    </div>
                  </div>
                )}
              </>
            ) : (
              <>
                {/* æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  */}
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">åå‰ *</label>
                    <input type="text" value={name} onChange={(e) => setName(e.target.value)}
                      className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="å±±ç”° å¤ªéƒ" />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">ãµã‚ŠãŒãª</label>
                    <input type="text" value={nameKana} onChange={(e) => setNameKana(e.target.value)}
                      className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="ã‚„ã¾ã  ãŸã‚ã†" />
                  </div>
                  <div className="grid grid-cols-3 gap-2">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-1">æ€§åˆ¥</label>
                      <select value={gender} onChange={(e) => setGender(e.target.value)}
                        className="w-full border-2 border-gray-200 rounded-xl px-2 py-2">
                        {genderOptions.map(g => <option key={g} value={g}>{g || 'é¸æŠ'}</option>)}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                      <select value={status} onChange={(e) => setStatus(e.target.value)}
                        className="w-full border-2 border-gray-200 rounded-xl px-2 py-2">
                        <option value="æ–°è¦">æ–°è¦</option>
                        <option value="å¸¸é€£">å¸¸é€£</option>
                        <option value="VIP">VIP</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-1">å¹´ä»£</label>
                      <select value={ageRange} onChange={(e) => setAgeRange(e.target.value)}
                        className="w-full border-2 border-gray-200 rounded-xl px-2 py-2">
                        {ageOptions.map(a => <option key={a} value={a}>{a || 'é¸æŠ'}</option>)}
                      </select>
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">è¦‹ãŸç›®ãƒ»ç‰¹å¾´</label>
                    <input type="text" value={appearance} onChange={(e) => setAppearance(e.target.value)}
                      className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="ãƒ¡ã‚¬ãƒã€é•·é«ª..." />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">å¥½ã¿ã®ãƒ‰ãƒªãƒ³ã‚¯</label>
                    <input type="text" value={favorite} onChange={(e) => setFavorite(e.target.value)}
                      className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="ãƒã‚¤ãƒœãƒ¼ãƒ«è–„ã‚" />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-1">ãƒ¡ãƒ¢</label>
                    <textarea value={notes} onChange={(e) => setNotes(e.target.value)}
                      className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" rows={2} placeholder="è©±é¡Œã€æ³¨æ„ç‚¹" />
                  </div>
                </div>

                <div className="flex gap-3 mt-5">
                  <button onClick={() => setMode('select')} className="flex-1 py-3 rounded-xl border-2 border-gray-300 font-semibold">
                    æˆ»ã‚‹
                  </button>
                  <button onClick={handleSaveNew} disabled={saving || !name.trim()}
                    className="flex-1 py-3 rounded-xl bg-blue-500 text-white font-semibold disabled:opacity-50">
                    {saving ? 'ç™»éŒ²ä¸­...' : `ç™»éŒ²ã—ã¦ç€å¸­ï¼ˆ${partySize}åï¼‰`}
                  </button>
                </div>
              </>
            )}
          </div>
        </div>
      );
    };

    // ============================================
    // æ³¨æ–‡è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆé¸æŠå¼ãƒ»ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯å¯¾å¿œï¼‰
    // ============================================
    const AddOrderModal = ({ customer, seatId, visitId, menuItems, users, workingStaff, onClose, onSave }) => {
      // å‡ºå‹¤ä¸­ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿è¡¨ç¤ºï¼ˆworkingStaffãŒç©ºã®å ´åˆã¯å…¨å“¡è¡¨ç¤ºï¼‰
      const availableStaff = workingStaff && workingStaff.length > 0
        ? users.filter(u => workingStaff.includes(u.id))
        : users;
      const [orderType, setOrderType] = useState('customer'); // customer, staff_drink
      const [selectedMenu, setSelectedMenu] = useState(null);
      const [staffId, setStaffId] = useState('');
      const [isBottleKeep, setIsBottleKeep] = useState(false);
      const [customItem, setCustomItem] = useState('');
      const [customPrice, setCustomPrice] = useState('');
      const [saving, setSaving] = useState(false);

      // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groupedMenu = menuItems.filter(m => m.is_active).reduce((acc, item) => {
        const cat = item.category || 'ãã®ä»–';
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(item);
        return acc;
      }, {});

      const handleSave = async () => {
        let item, price, order_type = orderType, staff_id = null;

        if (orderType === 'staff_drink') {
          if (!staffId) { alert('ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
          staff_id = staffId;
          item = isBottleKeep ? 'ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ï¼ˆãƒœãƒˆãƒ«ã‚­ãƒ¼ãƒ—ï¼‰' : 'ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯';
          price = isBottleKeep ? 500 : 1000;
        } else if (selectedMenu) {
          item = selectedMenu.name;
          price = selectedMenu.price;
        } else if (customItem && customPrice) {
          item = customItem;
          price = parseInt(customPrice);
        } else {
          alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é¸æŠã™ã‚‹ã‹ã€å“ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }

        setSaving(true);
        await onSave({
          customer_id: customer.id,
          seat_id: seatId,
          visit_id: visitId,
          item,
          price,
          order_type,
          staff_id
        });
        setSaving(false);
        // é€£ç¶šã§æ³¨æ–‡ã§ãã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
        setSelectedMenu(null);
        setCustomItem('');
        setCustomPrice('');
        setStaffId('');
        setIsBottleKeep(false);
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl p-5 w-full max-w-md max-h-[85vh] overflow-y-auto">
            <div className="flex justify-between items-center mb-3">
              <div>
                <h2 className="text-xl font-bold">ğŸ“ æ³¨æ–‡è¿½åŠ </h2>
                <p className="text-gray-500 text-sm">{customer.name}ã•ã‚“</p>
              </div>
              <button onClick={onClose} className="text-gray-400 text-2xl">&times;</button>
            </div>

            {/* æ³¨æ–‡ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ */}
            <div className="flex gap-2 mb-4">
              <button onClick={() => setOrderType('customer')}
                className={`flex-1 py-2 rounded-xl font-semibold text-sm ${orderType === 'customer' ? 'bg-blue-500 text-white' : 'bg-gray-100'}`}>
                ğŸº ãŠå®¢æ§˜æ³¨æ–‡
              </button>
              <button onClick={() => setOrderType('staff_drink')}
                className={`flex-1 py-2 rounded-xl font-semibold text-sm ${orderType === 'staff_drink' ? 'bg-pink-500 text-white' : 'bg-gray-100'}`}>
                ğŸ¥‚ ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯
              </button>
            </div>

            {orderType === 'customer' ? (
              <>
                {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ï¼‰ */}
                {Object.entries(groupedMenu).map(([category, items]) => (
                  <div key={category} className="mb-3">
                    <p className="text-xs font-semibold text-gray-500 mb-1">{category}</p>
                    <div className="flex flex-wrap gap-2">
                      {items.map(m => (
                        <button key={m.id} onClick={() => setSelectedMenu(m)}
                          className={`px-3 py-2 rounded-xl text-sm border-2 transition-all
                            ${selectedMenu?.id === m.id ? 'border-blue-500 bg-blue-50 text-blue-700' : 'border-gray-200 bg-white'}`}>
                          {m.name}<span className="text-gray-400 ml-1">Â¥{m.price}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                ))}

                {/* ã‚«ã‚¹ã‚¿ãƒ å…¥åŠ› */}
                <div className="border-t pt-3 mt-3">
                  <p className="text-xs font-semibold text-gray-500 mb-2">ãã®ä»–ï¼ˆæ‰‹å…¥åŠ›ï¼‰</p>
                  <div className="flex gap-2">
                    <input type="text" value={customItem} onChange={(e) => { setCustomItem(e.target.value); setSelectedMenu(null); }}
                      className="flex-1 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm" placeholder="å“ç›®å" />
                    <input type="number" value={customPrice} onChange={(e) => setCustomPrice(e.target.value)}
                      className="w-24 border-2 border-gray-200 rounded-xl px-3 py-2 text-sm" placeholder="é‡‘é¡" />
                  </div>
                </div>
              </>
            ) : (
              <>
                {/* ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ */}
                <div className="bg-pink-50 rounded-xl p-4 space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-pink-700 mb-2">èª°ãŒé£²ã‚“ã ï¼Ÿ</label>
                    <div className="flex flex-wrap gap-2">
                      {availableStaff.map(u => (
                        <button key={u.id} onClick={() => setStaffId(u.id)}
                          className={`px-4 py-2 rounded-full font-semibold transition-all ${
                            staffId === u.id
                              ? 'bg-pink-500 text-white'
                              : 'bg-white border-2 border-pink-300 text-pink-600'
                          }`}>
                          {u.name}
                        </button>
                      ))}
                    </div>
                    {availableStaff.length === 0 && (
                      <p className="text-sm text-pink-400 mt-2">å‡ºå‹¤ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    )}
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-pink-700 mb-2">ç¨®é¡</label>
                    <div className="flex gap-3">
                      <button onClick={() => setIsBottleKeep(false)}
                        className={`flex-1 py-3 rounded-xl font-semibold ${!isBottleKeep ? 'bg-pink-500 text-white' : 'bg-white border-2 border-pink-300'}`}>
                        é€šå¸¸ Â¥1,000
                      </button>
                      <button onClick={() => setIsBottleKeep(true)}
                        className={`flex-1 py-3 rounded-xl font-semibold ${isBottleKeep ? 'bg-pink-500 text-white' : 'bg-white border-2 border-pink-300'}`}>
                        ãƒœãƒˆãƒ«ã‚­ãƒ¼ãƒ— Â¥500
                      </button>
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* é¸æŠä¸­ã®è¡¨ç¤º */}
            {(selectedMenu || (customItem && customPrice) || (orderType === 'staff_drink' && staffId)) && (
              <div className="mt-4 p-3 bg-green-50 rounded-xl">
                <p className="text-sm text-green-700">
                  {orderType === 'staff_drink'
                    ? `${users.find(u => u.id === staffId)?.name || ''}ã®ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯: Â¥${isBottleKeep ? 500 : 1000}`
                    : selectedMenu
                      ? `${selectedMenu.name}: Â¥${selectedMenu.price}`
                      : `${customItem}: Â¥${customPrice}`
                  }
                </p>
              </div>
            )}

            <div className="flex gap-3 mt-4">
              <button onClick={onClose} className="flex-1 py-3 rounded-xl border-2 border-gray-300 font-semibold">é–‰ã˜ã‚‹</button>
              <button onClick={handleSave} disabled={saving}
                className="flex-1 py-3 rounded-xl bg-blue-500 text-white font-semibold disabled:opacity-50">
                {saving ? 'è¿½åŠ ä¸­...' : 'è¿½åŠ '}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // é¡§å®¢ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
    // ============================================
    const CustomerDetailModal = ({ customer, onClose, onSave }) => {
      const [name, setName] = useState(customer.name);
      const [nameKana, setNameKana] = useState(customer.name_kana || '');
      const [status, setStatus] = useState(customer.status || 'æ–°è¦');
      const [appearance, setAppearance] = useState(customer.appearance || '');
      const [ageRange, setAgeRange] = useState(customer.age_range || '');
      const [favorite, setFavorite] = useState(customer.favorite || '');
      const [notes, setNotes] = useState(customer.notes || '');
      const [saving, setSaving] = useState(false);

      const ageOptions = ['', '10ä»£', '20ä»£å‰åŠ', '20ä»£å¾ŒåŠ', '30ä»£å‰åŠ', '30ä»£å¾ŒåŠ', '40ä»£', '50ä»£', '60ä»£ä»¥ä¸Š'];

      const handleSave = async () => {
        if (!name.trim()) { alert('åå‰ã‚’å…¥åŠ›'); return; }
        setSaving(true);
        await onSave(customer.id, { name, name_kana: nameKana, status, appearance, age_range: ageRange, favorite, notes });
        setSaving(false);
        onClose();
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl p-5 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h2 className="text-xl font-bold mb-4">âœï¸ é¡§å®¢æƒ…å ±ç·¨é›†</h2>
            <div className="space-y-3">
              <input type="text" value={name} onChange={(e) => setName(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="åå‰" />
              <input type="text" value={nameKana} onChange={(e) => setNameKana(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="ãµã‚ŠãŒãª" />
              <div className="grid grid-cols-2 gap-3">
                <select value={status} onChange={(e) => setStatus(e.target.value)} className="border-2 border-gray-200 rounded-xl px-3 py-2">
                  <option value="æ–°è¦">æ–°è¦</option><option value="å¸¸é€£">å¸¸é€£</option><option value="VIP">VIP</option>
                </select>
                <select value={ageRange} onChange={(e) => setAgeRange(e.target.value)} className="border-2 border-gray-200 rounded-xl px-3 py-2">
                  {ageOptions.map(a => <option key={a} value={a}>{a || 'å¹´ä»£'}</option>)}
                </select>
              </div>
              <input type="text" value={appearance} onChange={(e) => setAppearance(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="è¦‹ãŸç›®ãƒ»ç‰¹å¾´" />
              <input type="text" value={favorite} onChange={(e) => setFavorite(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" placeholder="å¥½ã¿" />
              <textarea value={notes} onChange={(e) => setNotes(e.target.value)}
                className="w-full border-2 border-gray-200 rounded-xl px-3 py-2" rows={2} placeholder="ãƒ¡ãƒ¢" />
            </div>
            <div className="flex gap-3 mt-5">
              <button onClick={onClose} className="flex-1 py-3 rounded-xl border-2 border-gray-300 font-semibold">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button onClick={handleSave} disabled={saving} className="flex-1 py-3 rounded-xl bg-blue-500 text-white font-semibold disabled:opacity-50">
                {saving ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // ä¼šè¨ˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰
    // ============================================
    const CheckoutConfirmModal = ({ data, onConfirm, onCancel }) => {
      const [processing, setProcessing] = useState(false);

      if (!data) return null;

      const { customerOrderTotal, chargeTotal, staffDrinkTotal, grandTotal, partySize, chargeHours } = data;

      const handleConfirm = async () => {
        setProcessing(true);
        await onConfirm();
        setProcessing(false);
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl p-5 w-full max-w-sm">
            <h2 className="text-xl font-bold mb-4 text-center">ğŸ§¾ ä¼šè¨ˆç¢ºèª</h2>
            <div className="bg-gray-50 rounded-xl p-4 mb-4 space-y-2">
              <div className="flex justify-between">
                <span className="text-gray-600">æ³¨æ–‡</span>
                <span className="font-semibold">Â¥{customerOrderTotal.toLocaleString()}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ãƒãƒ£ãƒ¼ã‚¸ï¼ˆ{partySize}åÃ—{chargeHours}hï¼‰</span>
                <span className="font-semibold">Â¥{chargeTotal.toLocaleString()}</span>
              </div>
              {staffDrinkTotal > 0 && (
                <div className="flex justify-between">
                  <span className="text-gray-600">ã‚¹ã‚¿ãƒ‰ãƒª</span>
                  <span className="font-semibold">Â¥{staffDrinkTotal.toLocaleString()}</span>
                </div>
              )}
              <hr className="my-2" />
              <div className="flex justify-between text-lg">
                <span className="font-bold">åˆè¨ˆ</span>
                <span className="font-bold text-green-600">Â¥{grandTotal.toLocaleString()}</span>
              </div>
            </div>
            <p className="text-center text-gray-600 mb-4">é€€åº—å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</p>
            <div className="flex gap-3">
              <button
                onClick={onCancel}
                disabled={processing}
                className="flex-1 py-3 rounded-xl border-2 border-gray-300 font-semibold active:bg-gray-100 disabled:opacity-50"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button
                onClick={handleConfirm}
                disabled={processing}
                className="flex-1 py-3 rounded-xl bg-orange-500 text-white font-semibold active:bg-orange-600 disabled:opacity-50"
              >
                {processing ? 'å‡¦ç†ä¸­...' : 'OK é€€åº—'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // ç· ã‚ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚«ã‚¹ã‚¿ãƒ ï¼‰
    // ============================================
    const CloseConfirmModal = ({ data, onConfirm, onCancel }) => {
      const [processing, setProcessing] = useState(false);

      if (!data) return null;

      const { orderTotal, chargeTotal, staffDrinkTotal, totalSales, totalCustomers } = data;

      const handleConfirm = async () => {
        setProcessing(true);
        await onConfirm();
        setProcessing(false);
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-2xl p-5 w-full max-w-sm">
            <h2 className="text-xl font-bold mb-4 text-center">ğŸ” æœ¬æ—¥ã®å–¶æ¥­çµ‚äº†</h2>
            <div className="bg-red-50 rounded-xl p-4 mb-4 space-y-2">
              <div className="flex justify-between">
                <span className="text-gray-600">æ¥åº—çµ„æ•°</span>
                <span className="font-semibold">{totalCustomers}çµ„</span>
              </div>
              <hr className="my-2" />
              <div className="flex justify-between">
                <span className="text-gray-600">æ³¨æ–‡å£²ä¸Š</span>
                <span className="font-semibold">Â¥{orderTotal.toLocaleString()}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-600">ãƒãƒ£ãƒ¼ã‚¸</span>
                <span className="font-semibold">Â¥{chargeTotal.toLocaleString()}</span>
              </div>
              {staffDrinkTotal > 0 && (
                <div className="flex justify-between">
                  <span className="text-gray-600">ã‚¹ã‚¿ãƒ‰ãƒª</span>
                  <span className="font-semibold">Â¥{staffDrinkTotal.toLocaleString()}</span>
                </div>
              )}
              <hr className="my-2" />
              <div className="flex justify-between text-lg">
                <span className="font-bold">åˆè¨ˆå£²ä¸Š</span>
                <span className="font-bold text-red-600">Â¥{totalSales.toLocaleString()}</span>
              </div>
            </div>
            <p className="text-center text-gray-600 mb-4">ç· ã‚å‡¦ç†ã‚’è¡Œã„ã¾ã™ã‹ï¼Ÿ</p>
            <div className="flex gap-3">
              <button
                onClick={onCancel}
                disabled={processing}
                className="flex-1 py-3 rounded-xl border-2 border-gray-300 font-semibold active:bg-gray-100 disabled:opacity-50"
              >
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
              </button>
              <button
                onClick={handleConfirm}
                disabled={processing}
                className="flex-1 py-3 rounded-xl bg-red-500 text-white font-semibold active:bg-red-600 disabled:opacity-50"
              >
                {processing ? 'å‡¦ç†ä¸­...' : 'OK ç· ã‚'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // ãƒ•ãƒ­ã‚¢ãƒãƒƒãƒ—ç”»é¢ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¯¾å¿œï¼‰
    // ============================================
    const FloorMapPage = ({ seats, customers, orders, visits, users, onSelectSeat, onRefresh, currentTime }) => {
      // currentTimeã¯Appã‹ã‚‰å—ã‘å–ã‚‹ï¼ˆ10ç§’ã”ã¨ã«æ›´æ–°ã•ã‚Œã‚‹ï¼‰

      // å¸­ã‚’ã‚¿ã‚¤ãƒ—åˆ¥ã«åˆ†é¡
      const counterSeats = seats.filter(s => s.seat_type === 'counter').sort((a, b) => a.display_order - b.display_order);
      const tableSeats = seats.filter(s => s.seat_type && s.seat_type !== 'counter').sort((a, b) => a.display_order - b.display_order);

      const occupiedCount = seats.filter(s => s.occupied).length;

      // ä»Šæ—¥ã®å£²ä¸Šï¼ˆå†…è¨³ä»˜ãï¼‰
      // ä»Šæ—¥ã®å£²ä¸Šï¼ˆå…¨ã¦ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ã§é›†è¨ˆï¼‰
      const todayOrders = orders.filter(o => new Date(o.ordered_at).toDateString() === new Date().toDateString());
      const todayCustomerTotal = todayOrders.filter(o => !o.order_type || o.order_type === 'customer').reduce((sum, o) => sum + o.price, 0);
      const todayChargeTotal = todayOrders.filter(o => o.order_type === 'charge').reduce((sum, o) => sum + o.price, 0);
      const todayStaffDrinkTotal = todayOrders.filter(o => o.order_type === 'staff_drink').reduce((sum, o) => sum + o.price, 0);

      const todayTotal = todayCustomerTotal + todayChargeTotal + todayStaffDrinkTotal;

      const getCustomer = (seat) => seat.customer_id ? customers.find(c => c.id === seat.customer_id) : null;
      const getVisit = (seat) => seat.visit_id ? visits.find(v => v.id === seat.visit_id) : null;

      // ä»£è¡¨å¸­ã‹ã©ã†ã‹åˆ¤å®šï¼ˆvisitã®seat_idãŒä»£è¡¨å¸­ï¼‰
      const isPrimarySeat = (seat) => {
        if (!seat.visit_id) return false;
        const visit = visits.find(v => v.id === seat.visit_id);
        return visit?.seat_id === seat.id;
      };

      // ä»£è¡¨å¸­ã®IDã‚’å–å¾—
      const getPrimarySeatId = (seat) => {
        if (!seat.visit_id) return null;
        const visit = visits.find(v => v.id === seat.visit_id);
        return visit?.seat_id || null;
      };

      // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®å¸­ã‚’å–å¾—
      const getGroupSeats = (seat) => {
        if (!seat.visit_id) return [];
        return seats.filter(s => s.visit_id === seat.visit_id);
      };

      // ã‚°ãƒ«ãƒ¼ãƒ—ã®è‰²ï¼ˆvisit_idã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã§è‰²ã‚’æ±ºå®šï¼‰
      const groupColors = ['purple', 'pink', 'cyan', 'orange', 'lime', 'amber', 'teal', 'rose'];
      const getGroupColor = (seat) => {
        if (!seat.visit_id) return null;
        const groupSeats = getGroupSeats(seat);
        if (groupSeats.length <= 1) return null; // 1äººãªã‚‰è‰²ãªã—
        // visit_idã‹ã‚‰è‰²ã‚’æ±ºå®š
        const hash = seat.visit_id.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
        return groupColors[hash % groupColors.length];
      };

      // å¸­ã”ã¨ã®åˆè¨ˆï¼ˆä»£è¡¨å¸­ã®ã¿ã«è¡¨ç¤ºã€é€£ã‚Œå¸­ã¯0ï¼‰
      const getSeatTotal = (seat) => {
        const visit = visits.find(v => v.id === seat.visit_id);
        if (!visit) return 0;
        // ä»£è¡¨å¸­ã§ãªã„å ´åˆã¯0ã‚’è¿”ã™ï¼ˆè¡¨ç¤ºç”¨ï¼‰
        if (visit.seat_id !== seat.id) return 0;
        return orders.filter(o => o.visit_id === visit.id).reduce((sum, o) => sum + o.price, 0);
      };

      // ã‚°ãƒ«ãƒ¼ãƒ—å…¨ä½“ã®åˆè¨ˆã‚’å–å¾—ï¼ˆã©ã®å¸­ã‹ã‚‰ã§ã‚‚ï¼‰
      const getGroupTotal = (seat) => {
        const visit = visits.find(v => v.id === seat.visit_id);
        if (!visit) return 0;
        return orders.filter(o => o.visit_id === visit.id).reduce((sum, o) => sum + o.price, 0);
      };

      return (
        <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 p-3 pb-24">
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div className="bg-white rounded-2xl p-4 mb-3 shadow-lg">
            <div className="flex justify-between items-center">
              <div>
                <h1 className="text-xl font-bold text-gray-800">ğŸ¸ SHUFF <span className="text-sm text-gray-400">v5.0</span></h1>
                <p className="text-gray-500 text-xs">
                  {new Date().getMonth() + 1}æœˆ{new Date().getDate()}æ—¥ï¼ˆ{['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date().getDay()]}ï¼‰å–¶æ¥­ä¸­
                </p>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={onRefresh} className="p-2 rounded-lg hover:bg-gray-100 text-xl active:bg-gray-200">ğŸ”„</button>
                <div className="text-right">
                  <p className="text-xl font-bold text-blue-600">{occupiedCount}<span className="text-sm text-gray-400">/{seats.length}</span></p>
                  <p className="text-lg font-bold text-green-600">Â¥{todayTotal.toLocaleString()}</p>
                </div>
              </div>
            </div>
            {/* å£²ä¸Šå†…è¨³ */}
            <div className="flex justify-end gap-3 mt-2 text-xs text-gray-500">
              <span>æ³¨æ–‡ Â¥{todayCustomerTotal.toLocaleString()}</span>
              <span>ãƒãƒ£ãƒ¼ã‚¸ Â¥{todayChargeTotal.toLocaleString()}</span>
              <span className="text-pink-500">ã‚¹ã‚¿ãƒ‰ãƒª Â¥{todayStaffDrinkTotal.toLocaleString()}</span>
            </div>
          </div>

          {/* å‡¡ä¾‹ */}
          <div className="bg-white rounded-xl p-2 mb-3 shadow">
            <div className="flex justify-around text-xs">
              <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-yellow-100 border border-yellow-400"></div><span>VIP</span></div>
              <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-blue-100 border border-blue-400"></div><span>å¸¸é€£</span></div>
              <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-green-100 border border-green-400"></div><span>æ–°è¦</span></div>
              <div className="flex items-center gap-1"><div className="w-3 h-3 rounded bg-gray-200 border border-gray-300"></div><span>ç©ºå¸­</span></div>
            </div>
          </div>

          {/* ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */}
          <div className="bg-white rounded-2xl p-4 mb-3 shadow-lg">
            <div className="relative">
              {/* ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆUå­—å‹ã‚’è¡¨ç¾ï¼‰ */}
              <div className="bg-amber-800 rounded-2xl p-3 mb-2">
                <div className="bg-amber-700 rounded-xl h-8 flex items-center justify-center">
                  <span className="text-amber-200 text-xs font-semibold">BAR COUNTER</span>
                </div>
              </div>

              {/* ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­ */}
              <div className="flex justify-center gap-1 flex-wrap">
                {counterSeats.map(seat => (
                  <CounterSeat
                    key={seat.id}
                    seat={seat}
                    customer={getCustomer(seat)}
                    visit={getVisit(seat)}
                    seatTotal={getSeatTotal(seat)}
                    groupTotal={getGroupTotal(seat)}
                    isPrimary={isPrimarySeat(seat)}
                    primarySeatId={getPrimarySeatId(seat)}
                    groupColor={getGroupColor(seat)}
                    onSelect={onSelectSeat}
                    currentTime={currentTime}
                  />
                ))}
              </div>
              <p className="text-center text-xs text-gray-400 mt-2">
                ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆ{counterSeats.filter(s=>s.occupied).length}/{counterSeats.length}ï¼‰
              </p>
            </div>
          </div>

          {/* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒªã‚¢ */}
          {tableSeats.length > 0 && (
            <div className="bg-white rounded-2xl p-4 shadow-lg">
              <p className="text-sm font-semibold text-gray-700 mb-3">ğŸ½ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«å¸­</p>
              <div className="flex justify-around flex-wrap gap-3">
                {tableSeats.map(seat => (
                  <TableSeat
                    key={seat.id}
                    seat={seat}
                    customer={getCustomer(seat)}
                    visit={getVisit(seat)}
                    seatTotal={getSeatTotal(seat)}
                    groupTotal={getGroupTotal(seat)}
                    isPrimary={isPrimarySeat(seat)}
                    primarySeatId={getPrimarySeatId(seat)}
                    groupColor={getGroupColor(seat)}
                    onSelect={onSelectSeat}
                    currentTime={currentTime}
                  />
                ))}
              </div>
            </div>
          )}

          {/* ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯ãƒãƒƒã‚¯ï¼ˆå½“æ—¥ï¼‰ */}
          {(() => {
            const staffDrinkOrders = todayOrders.filter(o => o.order_type === 'staff_drink');
            if (staffDrinkOrders.length === 0) return null;
            // ã‚¹ã‚¿ãƒƒãƒ•åˆ¥ã«é›†è¨ˆ
            const staffStats = {};
            staffDrinkOrders.forEach(o => {
              if (!staffStats[o.staff_id]) staffStats[o.staff_id] = { count: 0, total: 0 };
              staffStats[o.staff_id].count++;
              staffStats[o.staff_id].total += o.price;
            });
            return (
              <div className="bg-pink-500 rounded-2xl p-4 mt-3 shadow-lg text-white">
                <div className="flex justify-between items-center mb-2">
                  <h3 className="font-semibold text-sm">ğŸ¥‚ æœ¬æ—¥ã®ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒªãƒ³ã‚¯</h3>
                  <div className="text-xl font-bold">Â¥{todayStaffDrinkTotal.toLocaleString()}</div>
                </div>
                <div className="space-y-1">
                  {Object.entries(staffStats).map(([staffId, stat]) => {
                    const staff = users.find(u => u.id === staffId);
                    return (
                      <div key={staffId} className="flex justify-between text-sm text-pink-100">
                        <span>{staff?.name || 'ä¸æ˜'}</span>
                        <span>{stat.count}æ¯ / Â¥{stat.total.toLocaleString()}</span>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })()}
        </div>
      );
    };

    // ============================================
    // é¡§å®¢è©³ç´°ç”»é¢ï¼ˆå¸­é¸æŠæ™‚ï¼‰
    // ============================================
    const CustomerDetailPage = ({ customer, seat, visit, orders, onBack, onAddOrder, onEdit, onCheckout, onRefresh, currentTime, onDeleteOrder }) => {
      // currentTimeã¯Appã‹ã‚‰å—ã‘å–ã‚‹ï¼ˆ10ç§’ã”ã¨ã«æ›´æ–°ã•ã‚Œã‚‹ï¼‰

      const visitOrders = orders.filter(o => o.visit_id === visit?.id);
      // æ³¨æ–‡åˆè¨ˆï¼ˆãƒãƒ£ãƒ¼ã‚¸ä»¥å¤–ï¼‰
      // å…¨ã¦ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ã§é›†è¨ˆ
      const customerOrderTotal = visitOrders.filter(o => !o.order_type || o.order_type === 'customer').reduce((sum, o) => sum + o.price, 0);
      const chargeTotal = visitOrders.filter(o => o.order_type === 'charge').reduce((sum, o) => sum + o.price, 0);
      const staffDrinkTotal = visitOrders.filter(o => o.order_type === 'staff_drink').reduce((sum, o) => sum + o.price, 0);
      const duration = visit?.seated_at ? Math.floor((currentTime - new Date(visit.seated_at).getTime()) / 60000) : 0;
      const partySize = visit?.party_size || 1;
      const grandTotal = customerOrderTotal + chargeTotal + staffDrinkTotal;

      // ã“ã®å¸­ãŒä»£è¡¨å¸­ã‹ã©ã†ã‹
      const isPrimary = visit?.seat_id === seat.id;
      const primarySeatId = visit?.seat_id;

      return (
        <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 p-3 pb-24">
          <button onClick={onBack} className="bg-white rounded-xl px-4 py-2 mb-3 shadow flex items-center gap-2 active:bg-gray-100">
            â† æˆ»ã‚‹
          </button>

          <div className="bg-white rounded-2xl p-4 mb-3 shadow-lg">
            <div className="flex justify-between items-start">
              <div>
                <div className="flex items-center gap-2 mb-1">
                  <h1 className="text-xl font-bold">{customer.name}</h1>
                  <span className={`px-2 py-0.5 rounded-full text-xs text-white ${getStatusColor(customer.status)}`}>{customer.status}</span>
                  {customer.gender && <span className="text-xs text-gray-400">{customer.gender}</span>}
                </div>
                <p className="text-gray-500 text-sm">
                  {seat.id}
                  {!isPrimary && primarySeatId && <span className="text-purple-500"> â†’ {primarySeatId}ï¼ˆä»£è¡¨ï¼‰</span>}
                  {' '}ï½œ {partySize > 1 ? `${partySize}å ï½œ ` : ''}{duration}åˆ†çµŒé
                </p>
                {customer.age_range && <p className="text-gray-400 text-xs mt-1">{customer.age_range}</p>}
              </div>
              <button onClick={onRefresh} className="text-xl p-1">ğŸ”„</button>
            </div>
          </div>

          {/* ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆé€£ã‚Œå¸­ï¼‰è¡¨ç¤º */}
          {partySize > 1 && (
            <div className={`rounded-xl p-3 mb-3 ${isPrimary ? 'bg-purple-500 text-white' : 'bg-purple-100 border-2 border-purple-400'}`}>
              <div className="flex items-center justify-between">
                <span className={`text-sm font-semibold ${isPrimary ? 'text-white' : 'text-purple-700'}`}>
                  ğŸ‘¥ {partySize}åã‚°ãƒ«ãƒ¼ãƒ—
                </span>
                {isPrimary ? (
                  <span className="text-xs bg-white text-purple-600 px-2 py-1 rounded-full font-semibold">ä»£è¡¨å¸­</span>
                ) : (
                  <span className="text-xs text-purple-600 font-semibold">ä¼šè¨ˆã¯ {primarySeatId} ã«é›†ç´„</span>
                )}
              </div>
            </div>
          )}

          {/* åˆè¨ˆé‡‘é¡ï¼ˆå†…è¨³ä»˜ãï¼‰ */}
          <div className="bg-green-500 rounded-2xl p-4 mb-3 shadow-lg text-white">
            <div className="flex justify-between items-center">
              <span className="font-semibold">ç¾åœ¨ã®åˆè¨ˆ</span>
              <span className="text-2xl font-bold">Â¥{grandTotal.toLocaleString()}</span>
            </div>
            <div className="flex justify-end gap-3 mt-1 text-sm text-green-100">
              <span>æ³¨æ–‡ Â¥{customerOrderTotal.toLocaleString()}</span>
              <span>ãƒãƒ£ãƒ¼ã‚¸ Â¥{chargeTotal.toLocaleString()}</span>
              {staffDrinkTotal > 0 && <span>ã‚¹ã‚¿ãƒ‰ãƒª Â¥{staffDrinkTotal.toLocaleString()}</span>}
            </div>
          </div>

          {(customer.favorite || customer.appearance || customer.notes) && (
            <div className="bg-white rounded-2xl p-4 mb-3 shadow-lg">
              <h2 className="font-semibold mb-2 text-sm">â­ é¡§å®¢ãƒ¡ãƒ¢</h2>
              {customer.appearance && <p className="text-xs bg-purple-50 p-2 rounded mb-2"><span className="font-semibold">ç‰¹å¾´:</span> {customer.appearance}</p>}
              {customer.favorite && <p className="text-xs bg-yellow-50 p-2 rounded mb-2"><span className="font-semibold">å¥½ã¿:</span> {customer.favorite}</p>}
              {customer.notes && <p className="text-xs bg-gray-50 p-2 rounded"><span className="font-semibold">ãƒ¡ãƒ¢:</span> {customer.notes}</p>}
            </div>
          )}

          <div className="bg-white rounded-2xl p-4 mb-3 shadow-lg">
            <div className="flex justify-between items-center mb-3">
              <h2 className="font-semibold text-sm">ğŸ“ æ³¨æ–‡å±¥æ­´</h2>
              <span className="text-xs text-amber-600 bg-amber-50 px-2 py-1 rounded">â±ï¸ ãƒãƒ£ãƒ¼ã‚¸è‡ªå‹•è¿½åŠ </span>
            </div>
            {visitOrders.length > 0 ? (
              <div className="space-y-1.5 max-h-48 overflow-y-auto">
                {visitOrders.map((o, i) => (
                  <div key={o.id || i} className={`flex justify-between items-center text-sm border-b pb-1 ${o.order_type === 'staff_drink' ? 'text-pink-600' : o.order_type === 'charge' ? 'text-amber-600' : ''}`}>
                    <span className="flex-1">
                      <span className="text-gray-400 mr-2 text-xs">{formatTime(o.ordered_at)}</span>
                      {o.item}
                      {o.order_type === 'staff_drink' && <span className="ml-1 text-xs">ğŸ¥‚</span>}
                      {o.order_type === 'charge' && <span className="ml-1 text-xs">â±ï¸</span>}
                    </span>
                    <span className="font-semibold mr-2">Â¥{o.price.toLocaleString()}</span>
                    <button
                      onClick={() => {
                        if (confirm(`ã€Œ${o.item}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                          onDeleteOrder(o.id);
                        }
                      }}
                      className="text-red-400 hover:text-red-600 text-xs px-1"
                    >
                      âœ•
                    </button>
                  </div>
                ))}
              </div>
            ) : <p className="text-gray-400 text-center py-2 text-sm">æ³¨æ–‡ãªã—</p>}
            <button onClick={onAddOrder} className="w-full mt-3 bg-blue-500 text-white py-2.5 rounded-xl font-semibold active:bg-blue-600">
              ï¼‹ æ³¨æ–‡è¿½åŠ 
            </button>
          </div>

          <div className="grid grid-cols-2 gap-3">
            <button onClick={onEdit} className="bg-gray-700 text-white py-3 rounded-xl font-semibold active:bg-gray-800">âœï¸ ç·¨é›†</button>
            <button onClick={onCheckout} className="bg-orange-500 text-white py-3 rounded-xl font-semibold active:bg-orange-600">ğŸšª ä¼šè¨ˆ Â¥{grandTotal.toLocaleString()}</button>
          </div>
        </div>
      );
    };

    // ============================================
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆå£²ä¸Šï¼‰
    // ============================================
    const DashboardPage = ({ orders, visits, customers, onRefresh }) => {
      const today = new Date();
      const todayStr = today.toDateString();

      const todayOrders = orders.filter(o => new Date(o.ordered_at).toDateString() === todayStr);
      const todayTotal = todayOrders.reduce((sum, o) => sum + o.price, 0);
      const todayCustomers = new Set(todayOrders.map(o => o.customer_id)).size;

      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      const weekOrders = orders.filter(o => new Date(o.ordered_at) >= weekAgo);
      const weekTotal = weekOrders.reduce((sum, o) => sum + o.price, 0);

      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      const monthOrders = orders.filter(o => new Date(o.ordered_at) >= monthStart);
      const monthTotal = monthOrders.reduce((sum, o) => sum + o.price, 0);

      const customerTotals = {};
      orders.forEach(o => { customerTotals[o.customer_id] = (customerTotals[o.customer_id] || 0) + o.price; });
      const ranking = Object.entries(customerTotals)
        .map(([id, total]) => ({ customer: customers.find(c => c.id === id), total }))
        .filter(r => r.customer)
        .sort((a, b) => b.total - a.total)
        .slice(0, 10);

      return (
        <div className="min-h-screen bg-gray-100 p-3 pb-24">
          <div className="flex justify-between items-center mb-3">
            <h1 className="text-xl font-bold">ğŸ“Š å£²ä¸Šãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <button onClick={onRefresh} className="text-xl p-1">ğŸ”„</button>
          </div>

          <div className="grid grid-cols-3 gap-2 mb-3">
            <div className="bg-white rounded-xl p-3 shadow text-center">
              <p className="text-xs text-gray-500">æœ¬æ—¥</p>
              <p className="text-lg font-bold text-green-600">Â¥{todayTotal.toLocaleString()}</p>
              <p className="text-xs text-gray-400">{todayCustomers}çµ„</p>
            </div>
            <div className="bg-white rounded-xl p-3 shadow text-center">
              <p className="text-xs text-gray-500">ä»Šé€±</p>
              <p className="text-lg font-bold text-blue-600">Â¥{weekTotal.toLocaleString()}</p>
            </div>
            <div className="bg-white rounded-xl p-3 shadow text-center">
              <p className="text-xs text-gray-500">ä»Šæœˆ</p>
              <p className="text-lg font-bold text-purple-600">Â¥{monthTotal.toLocaleString()}</p>
            </div>
          </div>

          <div className="bg-white rounded-xl p-4 shadow">
            <h2 className="font-semibold mb-3 text-sm">ğŸ† é¡§å®¢ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆç´¯è¨ˆï¼‰</h2>
            {ranking.length > 0 ? ranking.map((r, i) => (
              <div key={r.customer.id} className="flex justify-between items-center py-2 border-b last:border-0">
                <div className="flex items-center gap-2">
                  <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold
                    ${i === 0 ? 'bg-yellow-400 text-white' : i === 1 ? 'bg-gray-400 text-white' : i === 2 ? 'bg-orange-400 text-white' : 'bg-gray-200'}`}>
                    {i + 1}
                  </span>
                  <span className="text-sm font-medium">{r.customer.name}</span>
                </div>
                <span className="font-bold text-green-600 text-sm">Â¥{r.total.toLocaleString()}</span>
              </div>
            )) : <p className="text-gray-400 text-center py-4 text-sm">ãƒ‡ãƒ¼ã‚¿ãªã—</p>}
          </div>
        </div>
      );
    };

    // ============================================
    // ã‚¹ã‚¿ãƒƒãƒ•å£²ä¸Šãƒšãƒ¼ã‚¸ï¼ˆã‚¹ã‚¿ãƒ‰ãƒªï¼‰
    // ============================================
    const StaffSalesPage = ({ orders, users, onRefresh }) => {
      const [period, setPeriod] = useState('today'); // today, week, month, all

      // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      const getFilteredOrders = () => {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

        return orders.filter(o => {
          if (o.order_type !== 'staff_drink') return false;
          const orderDate = new Date(o.ordered_at);

          switch (period) {
            case 'today':
              return orderDate >= today;
            case 'week':
              const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
              return orderDate >= weekAgo;
            case 'month':
              const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
              return orderDate >= monthAgo;
            default:
              return true;
          }
        });
      };

      // ã‚¹ã‚¿ãƒƒãƒ•åˆ¥é›†è¨ˆ
      const getStaffStats = () => {
        const filtered = getFilteredOrders();
        const stats = {};

        filtered.forEach(o => {
          if (!o.staff_id) return;
          if (!stats[o.staff_id]) {
            stats[o.staff_id] = { count: 0, total: 0 };
          }
          stats[o.staff_id].count++;
          stats[o.staff_id].total += o.price;
        });

        // ã‚½ãƒ¼ãƒˆï¼ˆå£²ä¸Šé †ï¼‰
        return Object.entries(stats)
          .map(([staffId, stat]) => ({
            staffId,
            staff: users.find(u => u.id === staffId),
            ...stat
          }))
          .sort((a, b) => b.total - a.total);
      };

      const staffStats = getStaffStats();
      const totalAmount = staffStats.reduce((sum, s) => sum + s.total, 0);
      const totalCount = staffStats.reduce((sum, s) => sum + s.count, 0);

      return (
        <div className="min-h-screen bg-gradient-to-b from-pink-100 to-white p-3 pb-24">
          <div className="flex justify-between items-center mb-3">
            <h1 className="text-xl font-bold">ğŸ¥‚ ã‚¹ã‚¿ãƒƒãƒ•å£²ä¸Š</h1>
            <button onClick={onRefresh} className="text-xl p-1">ğŸ”„</button>
          </div>

          {/* æœŸé–“é¸æŠ */}
          <div className="flex gap-2 mb-4">
            {[
              { value: 'today', label: 'ä»Šæ—¥' },
              { value: 'week', label: 'ä»Šé€±' },
              { value: 'month', label: 'ä»Šæœˆ' },
              { value: 'all', label: 'å…¨æœŸé–“' },
            ].map(p => (
              <button key={p.value} onClick={() => setPeriod(p.value)}
                className={`flex-1 py-2 rounded-xl text-sm font-semibold transition-all ${
                  period === p.value
                    ? 'bg-pink-500 text-white'
                    : 'bg-white text-gray-600 border'
                }`}>
                {p.label}
              </button>
            ))}
          </div>

          {/* åˆè¨ˆ */}
          <div className="bg-pink-500 rounded-2xl p-6 mb-4 text-white shadow-lg">
            <div className="text-center">
              <p className="text-pink-200 text-sm">ã‚¹ã‚¿ãƒ‰ãƒªåˆè¨ˆ</p>
              <p className="text-4xl font-bold">Â¥{totalAmount.toLocaleString()}</p>
              <p className="text-pink-200 text-sm mt-1">{totalCount}æ¯</p>
            </div>
          </div>

          {/* ã‚¹ã‚¿ãƒƒãƒ•åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚° */}
          <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div className="bg-pink-100 px-4 py-3">
              <h2 className="font-semibold text-pink-800">ã‚¹ã‚¿ãƒƒãƒ•åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
            </div>
            <div className="divide-y">
              {staffStats.length > 0 ? (
                staffStats.map((stat, idx) => (
                  <div key={stat.staffId} className="flex items-center justify-between p-4">
                    <div className="flex items-center gap-3">
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${
                        idx === 0 ? 'bg-yellow-500' :
                        idx === 1 ? 'bg-gray-400' :
                        idx === 2 ? 'bg-amber-600' : 'bg-gray-200 text-gray-600'
                      }`}>
                        {idx + 1}
                      </div>
                      <div>
                        <p className="font-semibold">{stat.staff?.name || 'ä¸æ˜'}</p>
                        <p className="text-xs text-gray-500">{stat.count}æ¯</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="font-bold text-pink-600">Â¥{stat.total.toLocaleString()}</p>
                    </div>
                  </div>
                ))
              ) : (
                <div className="p-8 text-center text-gray-400">
                  <p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // é¡§å®¢ä¸€è¦§
    // ============================================
    const CustomersPage = ({ customers, orders, onRefresh, onEditCustomer }) => {
      const [search, setSearch] = useState('');
      const filtered = customers.filter(c =>
        c.name.toLowerCase().includes(search.toLowerCase()) ||
        (c.name_kana && c.name_kana.toLowerCase().includes(search.toLowerCase())) ||
        (c.appearance && c.appearance.toLowerCase().includes(search.toLowerCase()))
      );

      const customerTotals = {};
      orders.forEach(o => { customerTotals[o.customer_id] = (customerTotals[o.customer_id] || 0) + o.price; });

      return (
        <div className="min-h-screen bg-gray-100 p-3 pb-24">
          <div className="flex justify-between items-center mb-3">
            <h1 className="text-xl font-bold">ğŸ‘¥ é¡§å®¢ä¸€è¦§</h1>
            <button onClick={onRefresh} className="text-xl p-1">ğŸ”„</button>
          </div>
          <input type="text" value={search} onChange={(e) => setSearch(e.target.value)}
            className="w-full border-2 border-gray-200 rounded-xl px-4 py-2.5 mb-3" placeholder="åå‰ãƒ»ç‰¹å¾´ã§æ¤œç´¢..." />
          <div className="bg-white rounded-xl shadow overflow-hidden">
            {filtered.length > 0 ? filtered.map(c => (
              <button key={c.id} onClick={() => onEditCustomer(c)}
                className="w-full p-3 border-b last:border-0 flex justify-between items-center text-left active:bg-gray-50">
                <div>
                  <div className="flex items-center gap-1.5">
                    <span className="font-bold text-sm">{c.name}</span>
                    <span className={`px-1.5 py-0.5 rounded-full text-xs text-white ${getStatusColor(c.status)}`}>{c.status}</span>
                  </div>
                  <p className="text-xs text-gray-400">{c.favorite || 'å¥½ã¿æœªç™»éŒ²'}</p>
                </div>
                <span className="font-bold text-green-600 text-sm">Â¥{(customerTotals[c.id] || 0).toLocaleString()}</span>
              </button>
            )) : <p className="text-gray-400 text-center py-8 text-sm">é¡§å®¢ãªã—</p>}
          </div>
        </div>
      );
    };

    // ============================================
    // ã‚·ãƒ•ãƒˆç®¡ç†ç”»é¢
    // ============================================
    const ShiftPage = ({ users, shiftRequests, workingStaff, setWorkingStaff, onRefresh }) => {
      // === çŠ¶æ…‹ç®¡ç† ===
      const [activeTab, setActiveTab] = useState('submit');
      const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
      const [currentYear, setCurrentYear] = useState(new Date().getFullYear());

      // å¸Œæœ›æå‡ºç”¨
      const [selectedStaffId, setSelectedStaffId] = useState('');
      const [selectedDates, setSelectedDates] = useState(new Map()); // Map<dateStr, {start, end}>
      const [submitting, setSubmitting] = useState(false);

      // ã‚·ãƒ•ãƒˆç¢ºå®šç”¨
      const [editedShifts, setEditedShifts] = useState({}); // {dateStr: {staffId: {checked, start, end}}}
      const [confirmedDates, setConfirmedDates] = useState(new Set());

      // === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ===

      // æ—¥ä»˜ã‚’ "YYYY-MM-DD" å½¢å¼ã«æ­£è¦åŒ–
      const toDateStr = (input) => {
        if (!input) return '';
        if (input instanceof Date) {
          return `${input.getFullYear()}-${String(input.getMonth() + 1).padStart(2, '0')}-${String(input.getDate()).padStart(2, '0')}`;
        }
        const str = String(input).split('T')[0];
        const [y, m, d] = str.split('-');
        return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
      };

      // æ™‚é–“ã‚’ "HH:MM" å½¢å¼ã«æ­£è¦åŒ–ï¼ˆ"18:00:00" â†’ "18:00"ï¼‰
      const toTimeStr = (input) => {
        if (!input) return '19:00';
        const parts = String(input).split(':');
        return `${parts[0].padStart(2, '0')}:${parts[1] || '00'}`;
      };

      // === å®šæ•° ===
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayStr = toDateStr(today);

      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const firstDayOfWeek = new Date(currentYear, currentMonth, 1).getDay();

      const TIME_OPTIONS_START = ['18:00', '19:00', '20:00', '21:00', '22:00'];
      const TIME_OPTIONS_END = ['22:00', '23:00', '24:00', '25:00', '26:00', '27:00'];

      const staffList = users.filter(u => u.role === 'staff' || u.role === 'owner');

      // === ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ˜ãƒ«ãƒ‘ãƒ¼ ===
      const getStaffName = (staffId) => {
        const user = users.find(u => u.id === staffId);
        return user?.name || 'ä¸æ˜';
      };

      const getRequestsForDate = (dateStr) => {
        return shiftRequests.filter(r => toDateStr(r.work_date) === dateStr);
      };

      // æ·±å¤œæ™‚é–“ã‚’24+å½¢å¼ã«å¤‰æ›ï¼ˆ01:00â†’25:00ã€02:00â†’26:00ï¼‰
      const toDisplayTime = (timeStr, startTimeStr) => {
        const time = toTimeStr(timeStr);
        const [endHour] = time.split(':').map(Number);
        const [startHour] = toTimeStr(startTimeStr).split(':').map(Number);
        // çµ‚äº†æ™‚é–“ãŒé–‹å§‹æ™‚é–“ã‚ˆã‚Šå°ã•ã„å ´åˆã¯ç¿Œæ—¥ï¼ˆ24+è¡¨ç¤ºï¼‰
        if (endHour < startHour && endHour < 12) {
          return `${endHour + 24}:00`;
        }
        return time;
      };

      // ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰å¸Œæœ›æ™‚é–“ã‚’å–å¾—ï¼ˆ24+å½¢å¼ã§è¡¨ç¤ºï¼‰
      const getOriginalTime = (req) => {
        const start = toTimeStr(req.start_time);
        const end = toDisplayTime(req.end_time, req.start_time);
        return { start, end };
      };

      // ç·¨é›†çŠ¶æ…‹ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°å¸Œæœ›æ™‚é–“ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ï¼‰
      const getShiftState = (dateStr, req) => {
        const edited = editedShifts[dateStr]?.[req.staff_id];
        if (edited) return edited;
        const orig = getOriginalTime(req);
        return { checked: true, start: orig.start, end: orig.end };
      };

      // === å¸Œæœ›æå‡ºã‚¿ãƒ–ã®æ“ä½œ ===
      const toggleDateSelection = (dateStr) => {
        setSelectedDates(prev => {
          const next = new Map(prev);
          if (next.has(dateStr)) {
            next.delete(dateStr);
          } else {
            next.set(dateStr, { start: '19:00', end: '24:00' });
          }
          return next;
        });
      };

      const updateSelectedTime = (dateStr, field, value) => {
        setSelectedDates(prev => {
          const next = new Map(prev);
          const current = next.get(dateStr) || { start: '19:00', end: '24:00' };
          next.set(dateStr, { ...current, [field]: value });
          return next;
        });
      };

      const removeSelectedDate = (dateStr) => {
        setSelectedDates(prev => {
          const next = new Map(prev);
          next.delete(dateStr);
          return next;
        });
      };

      // 24æ™‚ã‚’è¶…ãˆã‚‹æ™‚é–“ã‚’æœ‰åŠ¹ãªTIMEå½¢å¼ã«å¤‰æ›ï¼ˆ25:00â†’01:00:00ï¼‰
      const convertToValidTime = (timeStr) => {
        const [hours, minutes] = timeStr.split(':').map(Number);
        const validHours = hours >= 24 ? hours - 24 : hours;
        return `${String(validHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:00`;
      };

      const submitShiftRequest = async () => {
        if (!selectedStaffId) {
          alert('ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        if (selectedDates.size === 0) {
          alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }

        console.log('[ã‚·ãƒ•ãƒˆé€ä¿¡] staff_id:', selectedStaffId);
        console.log('[ã‚·ãƒ•ãƒˆé€ä¿¡] é¸æŠæ—¥æ•°:', selectedDates.size);

        setSubmitting(true);
        try {
          for (const [dateStr, times] of selectedDates) {
            const payload = {
              staff_id: selectedStaffId,
              work_date: dateStr,
              start_time: convertToValidTime(times.start),
              end_time: convertToValidTime(times.end)
            };
            console.log('[ã‚·ãƒ•ãƒˆé€ä¿¡] payload:', payload);

            const { error } = await supabase.from('shift_requests').insert([payload]);
            if (error) {
              console.error('[ã‚·ãƒ•ãƒˆé€ä¿¡] ã‚¨ãƒ©ãƒ¼:', error);
              throw new Error(error);
            }
          }
          const staffName = getStaffName(selectedStaffId);
          alert(`${staffName}ã•ã‚“ã®ã‚·ãƒ•ãƒˆå¸Œæœ›ï¼ˆ${selectedDates.size}ä»¶ï¼‰ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼`);
          setSelectedDates(new Map());
          setSelectedStaffId('');
          onRefresh();
        } catch (err) {
          console.error('[ã‚·ãƒ•ãƒˆé€ä¿¡] ä¾‹å¤–:', err);
          alert('é€ä¿¡ã‚¨ãƒ©ãƒ¼: ' + (err.message || String(err)));
        } finally {
          setSubmitting(false);
        }
      };

      // === ã‚·ãƒ•ãƒˆç¢ºå®šã‚¿ãƒ–ã®æ“ä½œ ===
      const toggleStaffCheck = (dateStr, staffId, req) => {
        const current = getShiftState(dateStr, req);
        setEditedShifts(prev => ({
          ...prev,
          [dateStr]: {
            ...prev[dateStr],
            [staffId]: { ...current, checked: !current.checked }
          }
        }));
      };

      const updateConfirmTime = (dateStr, staffId, req, field, value) => {
        const current = getShiftState(dateStr, req);
        setEditedShifts(prev => ({
          ...prev,
          [dateStr]: {
            ...prev[dateStr],
            [staffId]: { ...current, [field]: value }
          }
        }));
      };

      const confirmDay = (dateStr) => {
        const requests = getRequestsForDate(dateStr);
        const checkedStaffIds = requests
          .filter(req => getShiftState(dateStr, req).checked)
          .map(req => req.staff_id);

        setConfirmedDates(prev => new Set([...prev, dateStr]));

        if (dateStr === todayStr) {
          setWorkingStaff(checkedStaffIds);
          alert(`æœ¬æ—¥ã®å‡ºå‹¤ã‚¹ã‚¿ãƒƒãƒ•ã‚’${checkedStaffIds.length}åã«è¨­å®šã—ã¾ã—ãŸ`);
        } else {
          alert(`${formatDateFull(dateStr)}ã®ã‚·ãƒ•ãƒˆã‚’ç¢ºå®šã—ã¾ã—ãŸï¼ˆ${checkedStaffIds.length}åï¼‰`);
        }
      };

      const deleteRequest = async (requestId) => {
        if (!confirm('ã“ã®å¸Œæœ›ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        await supabase.from('shift_requests').delete().eq('id', requestId);
        onRefresh();
      };

      // === æœˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ ===
      const prevMonth = () => {
        if (currentMonth === 0) {
          setCurrentMonth(11);
          setCurrentYear(y => y - 1);
        } else {
          setCurrentMonth(m => m - 1);
        }
      };

      const nextMonth = () => {
        if (currentMonth === 11) {
          setCurrentMonth(0);
          setCurrentYear(y => y + 1);
        } else {
          setCurrentMonth(m => m + 1);
        }
      };

      // === å¸Œæœ›ãŒã‚ã‚‹æ—¥ã®ãƒªã‚¹ãƒˆ ===
      const datesWithRequests = [];
      for (let i = 1; i <= daysInMonth; i++) {
        const d = new Date(currentYear, currentMonth, i);
        const dateStr = toDateStr(d);
        const requests = getRequestsForDate(dateStr);
        if (requests.length > 0) {
          datesWithRequests.push({
            date: d,
            dateStr,
            requests,
            isPast: d < today
          });
        }
      }

      // === ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ===
      return (
        <div className="min-h-screen bg-gray-100 p-3 pb-24">
          {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
          <div className="flex justify-between items-center mb-3">
            <h1 className="text-xl font-bold">ğŸ“… ã‚·ãƒ•ãƒˆç®¡ç†</h1>
            <button onClick={onRefresh} className="text-xl p-1">ğŸ”„</button>
          </div>

          {/* ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ */}
          <div className="flex gap-2 mb-3">
            <button onClick={() => setActiveTab('submit')}
              className={`flex-1 py-2 rounded-xl font-semibold text-sm ${activeTab === 'submit' ? 'bg-blue-500 text-white' : 'bg-white'}`}>
              å¸Œæœ›æå‡º
            </button>
            <button onClick={() => setActiveTab('confirm')}
              className={`flex-1 py-2 rounded-xl font-semibold text-sm ${activeTab === 'confirm' ? 'bg-green-500 text-white' : 'bg-white'}`}>
              ã‚·ãƒ•ãƒˆç¢ºå®š
            </button>
          </div>

          {activeTab === 'submit' ? (
            /* ========== å¸Œæœ›æå‡ºã‚¿ãƒ– ========== */
            <div className="bg-white rounded-xl p-4 shadow">
              {/* ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ */}
              <div className="mb-4">
                <label className="block text-sm font-semibold mb-1">ã‚¹ã‚¿ãƒƒãƒ•</label>
                <select
                  value={selectedStaffId}
                  onChange={(e) => setSelectedStaffId(e.target.value)}
                  className="w-full border-2 border-gray-200 rounded-xl px-3 py-3 bg-white"
                >
                  <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
                  {staffList.map(staff => (
                    <option key={staff.id} value={staff.id}>{staff.name}</option>
                  ))}
                </select>
                {staffList.length === 0 && (
                  <p className="text-xs text-orange-500 mt-1">â€» è¨­å®šç”»é¢ã§ã‚¹ã‚¿ãƒƒãƒ•ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                )}
              </div>

              {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */}
              <div className="mb-4">
                <div className="flex justify-between items-center mb-2">
                  <button onClick={prevMonth} className="p-2 rounded-full bg-gray-100">â—€</button>
                  <span className="font-bold">{currentYear}å¹´{currentMonth + 1}æœˆ</span>
                  <button onClick={nextMonth} className="p-2 rounded-full bg-gray-100">â–¶</button>
                </div>

                <div className="grid grid-cols-7 gap-1 text-center text-xs mb-1">
                  {['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].map((d, i) => (
                    <div key={d} className={`py-1 font-semibold ${i === 0 ? 'text-red-500' : i === 6 ? 'text-blue-500' : ''}`}>{d}</div>
                  ))}
                </div>

                <div className="grid grid-cols-7 gap-1">
                  {Array(firstDayOfWeek).fill(null).map((_, i) => <div key={`empty-${i}`}></div>)}
                  {Array.from({ length: daysInMonth }, (_, i) => {
                    const day = i + 1;
                    const d = new Date(currentYear, currentMonth, day);
                    const dateStr = toDateStr(d);
                    const isPast = d < today;
                    const isSelected = selectedDates.has(dateStr);
                    const dow = d.getDay();
                    return (
                      <button
                        key={day}
                        onClick={() => !isPast && toggleDateSelection(dateStr)}
                        disabled={isPast}
                        className={`aspect-square rounded-lg flex items-center justify-center text-sm font-medium
                          ${isPast ? 'text-gray-300' : isSelected ? 'bg-blue-500 text-white' : 'bg-gray-100'}
                          ${!isPast && !isSelected && dow === 0 ? 'text-red-500' : ''}
                          ${!isPast && !isSelected && dow === 6 ? 'text-blue-500' : ''}`}
                      >
                        {day}
                      </button>
                    );
                  })}
                </div>
              </div>

              {/* é¸æŠã—ãŸæ—¥ä»˜ã®æ™‚é–“è¨­å®š */}
              {selectedDates.size > 0 && (
                <div className="mb-4 bg-blue-50 rounded-xl p-3">
                  <p className="text-sm font-semibold text-blue-700 mb-3">ğŸ• å‹¤å‹™æ™‚é–“ã‚’è¨­å®šï¼ˆ{selectedDates.size}ä»¶ï¼‰</p>
                  <div className="space-y-2 max-h-48 overflow-y-auto">
                    {Array.from(selectedDates.entries())
                      .sort((a, b) => a[0].localeCompare(b[0]))
                      .map(([dateStr, times]) => (
                        <div key={dateStr} className="flex items-center gap-2 bg-white rounded-lg p-2">
                          <span className="text-sm font-medium min-w-[70px]">{formatDateFull(dateStr)}</span>
                          <select
                            value={times.start}
                            onChange={(e) => updateSelectedTime(dateStr, 'start', e.target.value)}
                            className="border rounded px-2 py-1 text-sm flex-1"
                          >
                            {TIME_OPTIONS_START.map(t => <option key={t} value={t}>{t}</option>)}
                          </select>
                          <span className="text-gray-400">ã€œ</span>
                          <select
                            value={times.end}
                            onChange={(e) => updateSelectedTime(dateStr, 'end', e.target.value)}
                            className="border rounded px-2 py-1 text-sm flex-1"
                          >
                            {TIME_OPTIONS_END.map(t => <option key={t} value={t}>{t}</option>)}
                          </select>
                          <button onClick={() => removeSelectedDate(dateStr)} className="text-red-400 hover:text-red-600 px-1">âœ•</button>
                        </div>
                      ))}
                  </div>
                </div>
              )}

              {/* é€ä¿¡ãƒœã‚¿ãƒ³ */}
              <button
                onClick={submitShiftRequest}
                disabled={submitting || !selectedStaffId || selectedDates.size === 0}
                className="w-full py-3 rounded-xl bg-blue-500 text-white font-semibold disabled:opacity-50"
              >
                {submitting ? 'é€ä¿¡ä¸­...' : 'ã‚·ãƒ•ãƒˆå¸Œæœ›ã‚’é€ä¿¡'}
              </button>
            </div>
          ) : (
            /* ========== ã‚·ãƒ•ãƒˆç¢ºå®šã‚¿ãƒ– ========== */
            <div className="space-y-3">
              {/* æœˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */}
              <div className="bg-white rounded-xl p-3 shadow">
                <div className="flex justify-between items-center">
                  <button onClick={prevMonth} className="p-2 rounded-full bg-gray-100">â—€</button>
                  <span className="font-bold">{currentYear}å¹´{currentMonth + 1}æœˆ</span>
                  <button onClick={nextMonth} className="p-2 rounded-full bg-gray-100">â–¶</button>
                </div>
              </div>

              {datesWithRequests.length === 0 ? (
                <div className="bg-white rounded-xl p-8 shadow text-center text-gray-400">
                  ã“ã®æœˆã®å¸Œæœ›ã¯ã‚ã‚Šã¾ã›ã‚“
                </div>
              ) : (
                datesWithRequests.map(({ date, dateStr, requests, isPast }) => {
                  const isToday = dateStr === todayStr;
                  const isConfirmed = confirmedDates.has(dateStr);

                  return (
                    <div key={dateStr} className={`bg-white rounded-xl shadow overflow-hidden ${isPast ? 'opacity-60' : ''}`}>
                      {/* æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ */}
                      <div className={`px-4 py-3 flex justify-between items-center ${isToday ? 'bg-green-50' : 'bg-gray-50'}`}>
                        <div>
                          <span className={`font-bold ${isToday ? 'text-green-700' : ''}`}>
                            {isToday && 'ğŸ“ '}{formatDateFull(dateStr)}
                            <span className={`ml-1 ${date.getDay() === 0 ? 'text-red-500' : date.getDay() === 6 ? 'text-blue-500' : 'text-gray-400'}`}>
                              ï¼ˆ{['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()]}ï¼‰
                            </span>
                          </span>
                          {isConfirmed && <span className="ml-2 text-green-600 text-sm">âœ“ ç¢ºå®šæ¸ˆã¿</span>}
                        </div>
                        {!isPast && (
                          <button
                            onClick={() => confirmDay(dateStr)}
                            className={`px-4 py-1 rounded-lg text-sm font-semibold text-white ${isToday ? 'bg-green-500' : 'bg-blue-500'}`}
                          >
                            {isConfirmed ? 'å†ç¢ºå®š' : 'ç¢ºå®š'}
                          </button>
                        )}
                      </div>

                      {/* ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰ */}
                      <div className="divide-y">
                        {requests.map(req => {
                          const state = getShiftState(dateStr, req);
                          const orig = getOriginalTime(req);
                          const isChanged = state.start !== orig.start || state.end !== orig.end;

                          // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆå¸Œæœ›æ™‚é–“ã‚’å«ã‚€ï¼‰
                          const startOpts = TIME_OPTIONS_START.includes(orig.start)
                            ? TIME_OPTIONS_START
                            : [...TIME_OPTIONS_START, orig.start].sort();
                          const endOpts = TIME_OPTIONS_END.includes(orig.end)
                            ? TIME_OPTIONS_END
                            : [...TIME_OPTIONS_END, orig.end].sort();

                          return (
                            <div key={req.id} className={`px-4 py-3 flex items-center gap-2 flex-wrap ${isPast ? 'pointer-events-none' : ''}`}>
                              <input
                                type="checkbox"
                                checked={state.checked}
                                onChange={() => toggleStaffCheck(dateStr, req.staff_id, req)}
                                className="w-4 h-4 rounded"
                                disabled={isPast}
                              />
                              <span className={`font-medium text-sm min-w-[60px] ${state.checked ? '' : 'text-gray-400'}`}>
                                {getStaffName(req.staff_id)}
                              </span>
                              <span className="text-gray-400 text-xs">
                                å¸Œæœ› {orig.start}-{orig.end}
                              </span>
                              <span className="text-gray-300">â†’</span>
                              <select
                                value={state.start}
                                onChange={(e) => updateConfirmTime(dateStr, req.staff_id, req, 'start', e.target.value)}
                                className={`border rounded px-1 py-0.5 text-xs ${isChanged ? 'border-orange-400 bg-orange-50' : ''}`}
                                disabled={isPast}
                              >
                                {startOpts.map(t => <option key={t} value={t}>{t}</option>)}
                              </select>
                              <span className="text-gray-400 text-xs">-</span>
                              <select
                                value={state.end}
                                onChange={(e) => updateConfirmTime(dateStr, req.staff_id, req, 'end', e.target.value)}
                                className={`border rounded px-1 py-0.5 text-xs ${isChanged ? 'border-orange-400 bg-orange-50' : ''}`}
                                disabled={isPast}
                              >
                                {endOpts.map(t => <option key={t} value={t}>{t}</option>)}
                              </select>
                              {isChanged && <span className="text-orange-500 text-xs font-medium">å¤‰æ›´</span>}
                              <button
                                onClick={() => deleteRequest(req.id)}
                                className="text-red-300 hover:text-red-500 text-xs ml-auto"
                                disabled={isPast}
                              >
                                å‰Šé™¤
                              </button>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          )}
        </div>
      );
    };

    // ============================================
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
    // ============================================
    const MenuManager = ({ menuItems, onRefresh }) => {
      const [showEditor, setShowEditor] = useState(false);
      const [editingItem, setEditingItem] = useState(null);
      const [newName, setNewName] = useState('');
      const [newPrice, setNewPrice] = useState('');
      const [newCategory, setNewCategory] = useState('ãƒ‰ãƒªãƒ³ã‚¯');
      const [saving, setSaving] = useState(false);
      const [importing, setImporting] = useState(false);

      const categories = ['ãƒ‰ãƒªãƒ³ã‚¯', 'ãƒ•ãƒ¼ãƒ‰', 'ãƒœãƒˆãƒ«', 'ãã®ä»–'];

      // CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
      const handleCSVImport = async (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        setImporting(true);
        try {
          const text = await file.text();
          const lines = text.split('\n').filter(line => line.trim());

          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæœ€åˆã®è¡ŒãŒã€Œåå‰ã€ã€Œå•†å“åã€ç­‰ã‚’å«ã‚€å ´åˆï¼‰
          const startIdx = lines[0].includes('åå‰') || lines[0].includes('å•†å“') || lines[0].includes('name') ? 1 : 0;

          let imported = 0;
          for (let i = startIdx; i < lines.length; i++) {
            const parts = lines[i].split(',').map(p => p.trim().replace(/"/g, ''));
            if (parts.length >= 2) {
              const name = parts[0];
              const price = parseInt(parts[1].replace(/[Â¥,]/g, ''));
              const category = parts[2] || 'ãƒ‰ãƒªãƒ³ã‚¯';

              if (name && !isNaN(price)) {
                await supabase.from('menu_items').insert([{
                  name,
                  price,
                  category: categories.includes(category) ? category : 'ãã®ä»–',
                  is_active: true,
                  display_order: menuItems.length + imported + 1
                }]);
                imported++;
              }
            }
          }

          alert(`${imported}ä»¶ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
          onRefresh();
        } catch (err) {
          alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
        } finally {
          setImporting(false);
          e.target.value = ''; // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠå¯èƒ½ã«
        }
      };

      const handleAddItem = async () => {
        if (!newName.trim() || !newPrice) { alert('åå‰ã¨ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        setSaving(true);
        await supabase.from('menu_items').insert([{
          name: newName.trim(),
          price: parseInt(newPrice),
          category: newCategory,
          is_active: true,
          display_order: menuItems.length + 1
        }]);
        setNewName('');
        setNewPrice('');
        setSaving(false);
        onRefresh();
      };

      const handleUpdateItem = async (item, updates) => {
        setSaving(true);
        await supabase.from('menu_items').update(updates).eq('id', item.id);
        setSaving(false);
        setEditingItem(null);
        onRefresh();
      };

      const handleDeleteItem = async (item) => {
        if (!confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        await supabase.from('menu_items').delete().eq('id', item.id);
        onRefresh();
      };

      const handleToggleActive = async (item) => {
        await supabase.from('menu_items').update({ is_active: !item.is_active }).eq('id', item.id);
        onRefresh();
      };

      // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const groupedItems = menuItems.reduce((acc, item) => {
        const cat = item.category || 'ãã®ä»–';
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(item);
        return acc;
      }, {});

      return (
        <div className="bg-white rounded-xl p-4 shadow mb-3">
          <div className="flex justify-between items-center mb-3">
            <h2 className="font-semibold text-sm">ğŸ“‹ ã‚¯ã‚¤ãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ({menuItems.filter(m => m.is_active).length}ä»¶)</h2>
            <div className="flex gap-2">
              <label className="px-3 py-1 bg-green-500 text-white rounded-lg text-sm cursor-pointer">
                {importing ? 'èª­è¾¼ä¸­...' : 'CSV'}
                <input type="file" accept=".csv,.txt" onChange={handleCSVImport} className="hidden" disabled={importing} />
              </label>
              <button onClick={() => setShowEditor(!showEditor)}
                className="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm">
                {showEditor ? 'é–‰ã˜ã‚‹' : 'ç·¨é›†'}
              </button>
            </div>
          </div>

          {!showEditor ? (
            <div className="flex flex-wrap gap-1">
              {menuItems.filter(m => m.is_active).map(m => (
                <span key={m.id} className="px-2 py-1 bg-gray-100 rounded-full text-xs">
                  {m.name} Â¥{m.price}
                </span>
              ))}
              {menuItems.filter(m => m.is_active).length === 0 && (
                <p className="text-gray-400 text-sm">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>
              )}
            </div>
          ) : (
            <div className="space-y-4">
              {/* æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */}
              <div className="bg-green-50 rounded-xl p-3">
                <p className="text-sm font-semibold text-green-700 mb-2">â• æ–°è¦è¿½åŠ </p>
                <div className="flex gap-2 mb-2">
                  <input type="text" value={newName} onChange={(e) => setNewName(e.target.value)}
                    className="flex-1 border-2 border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="å•†å“å" />
                  <input type="number" value={newPrice} onChange={(e) => setNewPrice(e.target.value)}
                    className="w-24 border-2 border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="ä¾¡æ ¼" />
                </div>
                <div className="flex gap-2">
                  <select value={newCategory} onChange={(e) => setNewCategory(e.target.value)}
                    className="flex-1 border-2 border-gray-200 rounded-lg px-3 py-2 text-sm">
                    {categories.map(c => <option key={c} value={c}>{c}</option>)}
                  </select>
                  <button onClick={handleAddItem} disabled={saving || !newName.trim() || !newPrice}
                    className="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-semibold disabled:opacity-50">
                    è¿½åŠ 
                  </button>
                </div>
              </div>

              {/* ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆ */}
              {categories.map(category => {
                const items = groupedItems[category] || [];
                if (items.length === 0) return null;
                return (
                  <div key={category}>
                    <p className="text-xs font-semibold text-gray-500 mb-1">{category}</p>
                    <div className="space-y-1">
                      {items.map(item => (
                        <div key={item.id} className={`flex items-center justify-between p-2 rounded-lg ${item.is_active ? 'bg-gray-50' : 'bg-gray-200 opacity-60'}`}>
                          {editingItem?.id === item.id ? (
                            <EditMenuItemForm item={item} categories={categories}
                              onSave={(updates) => handleUpdateItem(item, updates)}
                              onCancel={() => setEditingItem(null)} />
                          ) : (
                            <>
                              <div className="flex-1">
                                <span className="font-medium text-sm">{item.name}</span>
                                <span className="text-gray-500 text-sm ml-2">Â¥{item.price}</span>
                              </div>
                              <div className="flex items-center gap-1">
                                <button onClick={() => handleToggleActive(item)}
                                  className={`px-2 py-1 rounded text-xs ${item.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-300 text-gray-600'}`}>
                                  {item.is_active ? 'ON' : 'OFF'}
                                </button>
                                <button onClick={() => setEditingItem(item)}
                                  className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">âœï¸</button>
                                <button onClick={() => handleDeleteItem(item)}
                                  className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">ğŸ—‘ï¸</button>
                              </div>
                            </>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })}

              {menuItems.length === 0 && (
                <p className="text-center text-gray-400 py-4">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
              )}
            </div>
          )}
        </div>
      );
    };

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ 
    const EditMenuItemForm = ({ item, categories, onSave, onCancel }) => {
      const [name, setName] = useState(item.name);
      const [price, setPrice] = useState(item.price.toString());
      const [category, setCategory] = useState(item.category || 'ãã®ä»–');

      return (
        <div className="flex-1 flex gap-2 items-center">
          <input type="text" value={name} onChange={(e) => setName(e.target.value)}
            className="flex-1 border rounded px-2 py-1 text-sm" />
          <input type="number" value={price} onChange={(e) => setPrice(e.target.value)}
            className="w-20 border rounded px-2 py-1 text-sm" />
          <select value={category} onChange={(e) => setCategory(e.target.value)}
            className="border rounded px-2 py-1 text-sm">
            {categories.map(c => <option key={c} value={c}>{c}</option>)}
          </select>
          <button onClick={() => onSave({ name, price: parseInt(price), category })}
            className="px-2 py-1 bg-green-500 text-white rounded text-xs">ä¿å­˜</button>
          <button onClick={onCancel}
            className="px-2 py-1 bg-gray-300 rounded text-xs">Ã—</button>
        </div>
      );
    };

    // ============================================
    // è¨­å®šç”»é¢ï¼ˆå¸­ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®šè¿½åŠ ï¼‰
    // ============================================
    const SettingsPage = ({ seats, menuItems, users, workingStaff, setWorkingStaff, onRefresh, onResetSeats, onCloseBusiness, businessDay }) => {
      // å‡ºå‹¤ã‚¹ã‚¿ãƒƒãƒ•ã®åˆ‡ã‚Šæ›¿ãˆ
      const toggleWorkingStaff = (userId) => {
        if (workingStaff.includes(userId)) {
          setWorkingStaff(workingStaff.filter(id => id !== userId));
        } else {
          setWorkingStaff([...workingStaff, userId]);
        }
      };
      const [showLayoutSetup, setShowLayoutSetup] = useState(false);
      const [counterCount, setCounterCount] = useState('8');
      const [tables, setTables] = useState([{ id: 'T1', name: 'T1' }, { id: 'T2', name: 'T2' }]);
      const [newTableId, setNewTableId] = useState('');
      const [saving, setSaving] = useState(false);

      // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†
      const [showAddStaff, setShowAddStaff] = useState(false);
      const [newStaffName, setNewStaffName] = useState('');
      const [newStaffRole, setNewStaffRole] = useState('staff');
      const [addingStaff, setAddingStaff] = useState(false);

      const handleAddStaff = async () => {
        if (!newStaffName.trim()) { alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
        setAddingStaff(true);
        const { data, error } = await supabase.from('users').insert([{
          name: newStaffName.trim(),
          role: newStaffRole
        }]);
        setAddingStaff(false);
        if (error) {
          console.error('ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
          alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
          return;
        }
        alert(`${newStaffName}ã•ã‚“ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼`);
        setNewStaffName('');
        setNewStaffRole('staff');
        setShowAddStaff(false);
        onRefresh();
      };

      const handleDeleteStaff = async (userId, userName) => {
        if (!confirm(`ã€Œ${userName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        const { error } = await supabase.from('users').delete().eq('id', userId);
        if (error) {
          console.error('ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
          return;
        }
        onRefresh();
      };

      const handleAddTable = () => {
        if (!newTableId.trim()) return;
        if (tables.find(t => t.id === newTableId)) { alert('æ—¢ã«å­˜åœ¨'); return; }
        setTables([...tables, { id: newTableId, name: newTableId }]);
        setNewTableId('');
      };

      const handleRemoveTable = (id) => {
        setTables(tables.filter(t => t.id !== id));
      };

      const handleSaveLayout = async () => {
        if (!confirm('å¸­ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\nâ€»ç¾åœ¨ã®ç€å¸­æƒ…å ±ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™')) return;
        setSaving(true);

        // æ—¢å­˜ã®å¸­ã‚’å‰Šé™¤
        for (const seat of seats) {
          await supabase.from('seats').delete().eq('id', seat.id);
        }

        // æ–°ã—ã„å¸­ã‚’ä½œæˆ
        const newSeats = [];
        const count = parseInt(counterCount) || 8;
        for (let i = 1; i <= count; i++) {
          newSeats.push({ id: `C${i}`, seat_type: 'counter', display_order: i });
        }
        tables.forEach((t, i) => {
          newSeats.push({ id: t.id, seat_type: 'table', display_order: count + i + 1 });
        });

        for (const seat of newSeats) {
          await supabase.from('seats').insert([seat]);
        }

        setSaving(false);
        alert('å¸­ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
        setShowLayoutSetup(false);
        onRefresh();
      };

      return (
        <div className="min-h-screen bg-gray-100 p-3 pb-24">
          <div className="flex justify-between items-center mb-3">
            <h1 className="text-xl font-bold">âš™ï¸ è¨­å®š</h1>
            <button onClick={onRefresh} className="text-xl p-1">ğŸ”„</button>
          </div>

          {/* å–¶æ¥­çµ‚äº†ï¼ˆç· ã‚ï¼‰ */}
          <div className="bg-red-50 border-2 border-red-200 rounded-xl p-4 shadow mb-3">
            <div className="flex justify-between items-center">
              <div>
                <h2 className="font-semibold text-red-700">ğŸ” æœ¬æ—¥ã®å–¶æ¥­</h2>
                {businessDay && (
                  <p className="text-xs text-gray-500 mt-1">
                    é–‹åº—: {new Date(businessDay.opened_at).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' })}
                  </p>
                )}
              </div>
              <button
                onClick={onCloseBusiness}
                className="px-4 py-2 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600 active:bg-red-700"
              >
                ç· ã‚ï¼ˆå–¶æ¥­çµ‚äº†ï¼‰
              </button>
            </div>
          </div>

          {/* æœ¬æ—¥ã®å‡ºå‹¤ã‚¹ã‚¿ãƒƒãƒ• */}
          <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4 shadow mb-3">
            <h2 className="font-semibold text-green-700 mb-3">ğŸ‘¥ æœ¬æ—¥ã®å‡ºå‹¤ã‚¹ã‚¿ãƒƒãƒ•</h2>
            {users.length === 0 ? (
              <p className="text-gray-400 text-sm">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸‹ã®ã€Œã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã€ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
            ) : (
              <>
                <div className="flex flex-wrap gap-2 mb-3">
                  {users.map(user => (
                    <button key={user.id} onClick={() => toggleWorkingStaff(user.id)}
                      className={`px-4 py-2 rounded-full text-sm font-semibold transition-all ${
                        workingStaff.includes(user.id)
                          ? 'bg-green-500 text-white shadow-md'
                          : 'bg-white border-2 border-green-300 text-green-700'
                      }`}>
                      {workingStaff.includes(user.id) && 'âœ“ '}{user.name}
                    </button>
                  ))}
                </div>
                <div className="flex justify-between items-center text-sm">
                  <span className="text-green-700">
                    {workingStaff.length > 0
                      ? `${workingStaff.length}åãŒå‡ºå‹¤ä¸­`
                      : 'å‡ºå‹¤ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„'}
                  </span>
                  {workingStaff.length > 0 && (
                    <button onClick={() => setWorkingStaff([])} className="text-gray-400 hover:text-gray-600">
                      ã‚¯ãƒªã‚¢
                    </button>
                  )}
                </div>
              </>
            )}
          </div>

          {/* å¸­ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š */}
          <div className="bg-white rounded-xl p-4 shadow mb-3">
            <div className="flex justify-between items-center mb-3">
              <h2 className="font-semibold text-sm">ğŸª‘ å¸­ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</h2>
              <div className="flex gap-2">
                <button onClick={async () => {
                  if (!confirm('å¸­ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆC1ã€œC8 + T1, T2ï¼‰ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
                  setSaving(true);
                  // å…¨å¸­å‰Šé™¤
                  for (const seat of seats) {
                    await supabase.from('seats').delete().eq('id', seat.id);
                  }
                  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¸­ä½œæˆ
                  const defaultSeats = [];
                  for (let i = 1; i <= 8; i++) {
                    defaultSeats.push({ id: `C${i}`, seat_type: 'counter', display_order: i, occupied: false });
                  }
                  defaultSeats.push({ id: 'T1', seat_type: 'table', display_order: 9, occupied: false });
                  defaultSeats.push({ id: 'T2', seat_type: 'table', display_order: 10, occupied: false });
                  for (const seat of defaultSeats) {
                    await supabase.from('seats').insert([seat]);
                  }
                  setSaving(false);
                  alert('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æˆ»ã—ã¾ã—ãŸï¼');
                  onRefresh();
                }}
                  className="px-3 py-1 bg-orange-500 text-white rounded-lg text-sm">
                  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                </button>
                <button onClick={() => setShowLayoutSetup(!showLayoutSetup)}
                  className="px-3 py-1 bg-blue-500 text-white rounded-lg text-sm">
                  {showLayoutSetup ? 'é–‰ã˜ã‚‹' : 'ç·¨é›†'}
                </button>
              </div>
            </div>

            {!showLayoutSetup ? (
              <div className="text-sm text-gray-600">
                <p>ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼: {seats.filter(s => s.seat_type === 'counter').length}å¸­</p>
                <p>ãƒ†ãƒ¼ãƒ–ãƒ«: {seats.filter(s => s.seat_type && s.seat_type !== 'counter').map(s => s.id).join(', ') || 'ãªã—'}</p>
              </div>
            ) : (
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold mb-2">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­æ•°</label>
                  <div className="flex gap-2">
                    {[5,6,7,8,9,10,12].map(n => (
                      <button key={n} onClick={() => setCounterCount(n.toString())}
                        className={`w-10 h-10 rounded-lg font-bold ${counterCount === n.toString() ? 'bg-blue-500 text-white' : 'bg-gray-100'}`}>
                        {n}
                      </button>
                    ))}
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-2">ãƒ†ãƒ¼ãƒ–ãƒ«å¸­</label>
                  <div className="flex flex-wrap gap-2 mb-2">
                    {tables.map(t => (
                      <div key={t.id} className="flex items-center gap-1 bg-gray-100 px-3 py-1 rounded-full">
                        <span>{t.id}</span>
                        <button onClick={() => handleRemoveTable(t.id)} className="text-red-500 ml-1">Ã—</button>
                      </div>
                    ))}
                  </div>
                  <div className="flex gap-2">
                    <input type="text" value={newTableId} onChange={(e) => setNewTableId(e.target.value.toUpperCase())}
                      className="flex-1 border-2 border-gray-200 rounded-lg px-3 py-2 text-sm" placeholder="ãƒ†ãƒ¼ãƒ–ãƒ«IDï¼ˆä¾‹: T3ï¼‰" />
                    <button onClick={handleAddTable} className="px-4 py-2 bg-gray-200 rounded-lg text-sm">è¿½åŠ </button>
                  </div>
                </div>

                <button onClick={handleSaveLayout} disabled={saving}
                  className="w-full py-3 bg-green-500 text-white rounded-xl font-semibold disabled:opacity-50">
                  {saving ? 'ä¿å­˜ä¸­...' : 'ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜'}
                </button>
              </div>
            )}
          </div>

          {/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç† */}
          <MenuManager menuItems={menuItems} onRefresh={onRefresh} />

          {/* ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† */}
          <div className="bg-white rounded-xl p-4 shadow">
            <div className="flex justify-between items-center mb-3">
              <h2 className="font-semibold text-sm">ğŸ‘¤ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç† ({users.length}å)</h2>
              <button onClick={() => setShowAddStaff(!showAddStaff)}
                className="px-3 py-1 bg-pink-500 text-white rounded-lg text-sm">
                {showAddStaff ? 'é–‰ã˜ã‚‹' : 'ï¼‹ è¿½åŠ '}
              </button>
            </div>

            {/* ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  */}
            {showAddStaff && (
              <div className="bg-pink-50 rounded-xl p-4 mb-3">
                <p className="text-sm font-semibold text-pink-700 mb-3">æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ </p>
                <div className="space-y-3">
                  <div>
                    <label className="block text-xs text-pink-600 mb-1">åå‰</label>
                    <input type="text" value={newStaffName} onChange={(e) => setNewStaffName(e.target.value)}
                      className="w-full border-2 border-pink-200 rounded-lg px-3 py-2 bg-white" placeholder="ä¾‹: å±±ç”°å¤ªéƒ" />
                  </div>
                  <div>
                    <label className="block text-xs text-pink-600 mb-1">å½¹å‰²</label>
                    <select value={newStaffRole} onChange={(e) => setNewStaffRole(e.target.value)}
                      className="w-full border-2 border-pink-200 rounded-lg px-3 py-2 bg-white">
                      <option value="staff">ã‚¹ã‚¿ãƒƒãƒ•</option>
                      <option value="owner">ã‚ªãƒ¼ãƒŠãƒ¼</option>
                    </select>
                  </div>
                  <button onClick={handleAddStaff} disabled={addingStaff || !newStaffName.trim()}
                    className="w-full py-3 bg-pink-500 text-white rounded-lg font-semibold disabled:opacity-50 active:bg-pink-600">
                    {addingStaff ? 'ç™»éŒ²ä¸­...' : 'âœ“ ã‚¹ã‚¿ãƒƒãƒ•ã‚’ç™»éŒ²'}
                  </button>
                </div>
              </div>
            )}

            {/* ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ */}
            <div className="space-y-1">
              {users.map(u => (
                <div key={u.id} className="flex justify-between items-center py-2 border-b last:border-0">
                  <div className="flex items-center gap-2">
                    <span className="text-sm font-medium">{u.name}</span>
                    <span className={`text-xs px-2 py-0.5 rounded-full ${u.role === 'owner' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100'}`}>
                      {u.role === 'owner' ? 'ã‚ªãƒ¼ãƒŠãƒ¼' : 'ã‚¹ã‚¿ãƒƒãƒ•'}
                    </span>
                  </div>
                  <button onClick={() => handleDeleteStaff(u.id, u.name)}
                    className="text-red-400 hover:text-red-600 text-sm px-2">å‰Šé™¤</button>
                </div>
              ))}
              {users.length === 0 && (
                <p className="text-center text-gray-400 py-2 text-sm">ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ============================================
    // é–‹åº—ç”»é¢ï¼ˆå…¥ã‚Šï¼‰- ã‚¹ã‚¿ãƒƒãƒ•å‡ºå‹¤é¸æŠä»˜ã
    // ============================================
    const OpeningScreen = ({ onOpen, users }) => {
      const today = new Date();
      const dateStr = `${today.getFullYear()}å¹´${today.getMonth() + 1}æœˆ${today.getDate()}æ—¥`;
      const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][today.getDay()];
      const [workingStaff, setWorkingStaff] = useState([]);

      const toggleStaff = (userId) => {
        if (workingStaff.includes(userId)) {
          setWorkingStaff(workingStaff.filter(id => id !== userId));
        } else {
          setWorkingStaff([...workingStaff, userId]);
        }
      };

      const handleOpen = () => {
        onOpen(workingStaff);
      };

      return (
        <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800 flex items-center justify-center p-4">
          <div className="bg-white rounded-3xl p-8 shadow-2xl text-center max-w-sm w-full">
            <h1 className="text-3xl font-bold text-gray-800 mb-2">ğŸ¸ SHUFF</h1>
            <p className="text-gray-500 mb-6">ãƒãƒ¼ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  v5.0</p>

            <div className="bg-gray-100 rounded-2xl p-6 mb-4">
              <p className="text-sm text-gray-500">æœ¬æ—¥</p>
              <p className="text-2xl font-bold text-gray-800">{dateStr}</p>
              <p className="text-lg text-gray-600">ï¼ˆ{dayOfWeek}æ›œæ—¥ï¼‰</p>
            </div>

            {/* ã‚¹ã‚¿ãƒƒãƒ•å‡ºå‹¤é¸æŠ */}
            {users && users.length > 0 && (
              <div className="bg-pink-50 rounded-2xl p-4 mb-4 text-left">
                <p className="text-sm font-semibold text-pink-700 mb-3">ğŸ‘¥ æœ¬æ—¥ã®å‡ºå‹¤ã‚¹ã‚¿ãƒƒãƒ•</p>
                <div className="flex flex-wrap gap-2">
                  {users.map(user => (
                    <button
                      key={user.id}
                      onClick={() => toggleStaff(user.id)}
                      className={`px-4 py-2 rounded-full text-sm font-semibold transition-all ${
                        workingStaff.includes(user.id)
                          ? 'bg-pink-500 text-white'
                          : 'bg-white border-2 border-pink-300 text-pink-600'
                      }`}
                    >
                      {user.name}
                    </button>
                  ))}
                </div>
                {workingStaff.length > 0 && (
                  <p className="text-xs text-pink-600 mt-2">âœ“ {workingStaff.length}åé¸æŠä¸­</p>
                )}
              </div>
            )}

            <button
              onClick={handleOpen}
              className="w-full bg-green-500 text-white text-xl font-bold py-4 px-8 rounded-2xl shadow-lg hover:bg-green-600 active:bg-green-700 transition-all"
            >
              ğŸšª é–‹åº—ï¼ˆå…¥ã‚Šï¼‰
            </button>

            <p className="text-xs text-gray-400 mt-4">é–‹åº—ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å–¶æ¥­ã‚’é–‹å§‹ã—ã¾ã™</p>
          </div>
        </div>
      );
    };

    // ============================================
    // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª
    // ============================================
    function App() {
      const [seats, setSeats] = useState([]);
      const [customers, setCustomers] = useState([]);
      const [orders, setOrders] = useState([]);
      const [visits, setVisits] = useState([]);
      const [menuItems, setMenuItems] = useState([]);
      const [users, setUsers] = useState([]);
      const [shiftRequests, setShiftRequests] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      const [currentPage, setCurrentPage] = useState('floor');
      const [selectedSeat, setSelectedSeat] = useState(null);
      const [showNewCustomer, setShowNewCustomer] = useState(false);
      const [showAddOrder, setShowAddOrder] = useState(false);
      const [editingCustomer, setEditingCustomer] = useState(null);
      const [showCheckoutConfirm, setShowCheckoutConfirm] = useState(false);
      const [checkoutData, setCheckoutData] = useState(null);
      const [showCloseConfirm, setShowCloseConfirm] = useState(false);
      const [closeData, setCloseData] = useState(null);

      // å–¶æ¥­ç®¡ç†ï¼ˆå…¥ã‚Šãƒ»ç· ã‚ï¼‰
      const [isOpen, setIsOpen] = useState(false);
      const [businessDay, setBusinessDay] = useState(null);
      const [workingStaff, setWorkingStaff] = useState([]); // æœ¬æ—¥ã®å‡ºå‹¤ã‚¹ã‚¿ãƒƒãƒ•ID

      // æ™‚é–“çµŒéè¡¨ç¤ºç”¨ï¼š10ç§’ã”ã¨ã«ç¾åœ¨æ™‚åˆ»ã‚’æ›´æ–°
      const [currentTime, setCurrentTime] = useState(Date.now());
      useEffect(() => {
        const timer = setInterval(() => {
          setCurrentTime(Date.now());
        }, 10000); // 10ç§’ã”ã¨
        return () => clearInterval(timer);
      }, []);

      // è‡ªå‹•ãƒãƒ£ãƒ¼ã‚¸è¿½åŠ ï¼šæ™‚é–“çµŒéã«å¿œã˜ã¦ãƒãƒ£ãƒ¼ã‚¸ã‚’è‡ªå‹•è¿½åŠ 
      const autoAddChargesRef = React.useRef(false); // å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°
      const lastChargeCheckRef = React.useRef(0); // æœ€å¾Œã«ãƒã‚§ãƒƒã‚¯ã—ãŸæ™‚é–“

      useEffect(() => {
        if (!isOpen) return;

        // â˜… å‡¦ç†ä¸­ãªã‚‰å³åº§ã«ãƒªã‚¿ãƒ¼ãƒ³ï¼ˆRace Conditioné˜²æ­¢ï¼‰
        if (autoAddChargesRef.current) return;

        // 1åˆ†ä»¥å†…ã«å†å®Ÿè¡Œã—ãªã„ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        const now = Date.now();
        if (now - lastChargeCheckRef.current < 60000) return;

        // â˜… ãƒ•ãƒ©ã‚°ã‚’å³åº§ã«è¨­å®šï¼ˆasyncé–¢æ•°ã®å¤–ã§ï¼ï¼‰
        autoAddChargesRef.current = true;
        lastChargeCheckRef.current = now;

        const checkAndAddCharges = async () => {
          try {
            // â˜… visitsã‚‚DBã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆstateã«ä¾å­˜ã—ãªã„ï¼‰
            const { data: latestVisits } = await supabase.from('visits').select('*');
            const { data: latestOrders } = await supabase.from('orders').select('*');
            if (!latestVisits || !latestOrders) return;

            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªæ¥åº—ã‚’å–å¾—
            const activeVisits = latestVisits.filter(v => v.is_active && v.seated_at);

            let hasChanges = false;

            for (const visit of activeVisits) {
              // visit.seat_id ãŒä»£è¡¨å¸­ï¼ˆprimary seatï¼‰
              const primarySeatId = visit.seat_id;
              if (!primarySeatId) continue;

              // çµŒéæ™‚é–“ã‹ã‚‰å¿…è¦ãªãƒãƒ£ãƒ¼ã‚¸å›æ•°ã‚’è¨ˆç®—ï¼ˆ1æ™‚é–“ã”ã¨ï¼‰
              const elapsedMs = Date.now() - new Date(visit.seated_at).getTime();
              const elapsedHours = Math.floor(elapsedMs / (60 * 60 * 1000)) + 1;

              // ç¾åœ¨ã®ãƒãƒ£ãƒ¼ã‚¸å›æ•°ï¼ˆDBã‹ã‚‰å–å¾—ã—ãŸæœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§è¨ˆç®—ï¼‰
              const chargeOrders = latestOrders.filter(o => o.visit_id === visit.id && o.order_type === 'charge');
              const currentCharges = chargeOrders.length;

              // è¶³ã‚Šãªã„åˆ†ã‚’è¿½åŠ ï¼ˆä»£è¡¨å¸­ã«è¨˜éŒ²ï¼‰
              if (elapsedHours > currentCharges) {
                const partySize = visit.party_size || 1;
                const chargeAmount = CHARGE_PER_HOUR * partySize;

                for (let h = currentCharges + 1; h <= elapsedHours; h++) {
                  await supabase.from('orders').insert([{
                    customer_id: visit.customer_id,
                    seat_id: primarySeatId,
                    visit_id: visit.id,
                    item: `ãƒãƒ£ãƒ¼ã‚¸ ${h}hï¼ˆ${partySize}åï¼‰`,
                    price: chargeAmount,
                    order_type: 'charge'
                  }]);
                  hasChanges = true;
                }
              }
            }

            // å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—
            if (hasChanges) {
              const { data: newOrders } = await supabase.from('orders').select('*');
              if (newOrders) setOrders(newOrders);
            }
          } finally {
            autoAddChargesRef.current = false;
          }
        };

        checkAndAddCharges();
      }, [currentTime, isOpen]); // â˜… visits, seatsã‚’ä¾å­˜é…åˆ—ã‹ã‚‰å‰Šé™¤

      const fetchData = async () => {
        setLoading(true);
        try {
          const [seatsRes, customersRes, ordersRes, visitsRes, menuRes, usersRes, shiftReqRes, businessDaysRes] = await Promise.all([
            supabase.from('seats').select('*'),
            supabase.from('customers').select('*'),
            supabase.from('orders').select('*'),
            supabase.from('visits').select('*'),
            supabase.from('menu_items').select('*'),
            supabase.from('users').select('*'),
            supabase.from('shift_requests').select('*'),
            supabase.from('business_days').select('*').eq('business_date', new Date().toISOString().split('T')[0]).single(),
          ]);

          let seatsData = seatsRes.data || [];

          // å¸­ãŒãªã„å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å¸­ã‚’ä½œæˆ
          if (seatsData.length === 0) {
            const defaultSeats = [];
            for (let i = 1; i <= 8; i++) {
              defaultSeats.push({ id: `C${i}`, seat_type: 'counter', display_order: i });
            }
            defaultSeats.push({ id: 'T1', seat_type: 'table', display_order: 9 });
            defaultSeats.push({ id: 'T2', seat_type: 'table', display_order: 10 });

            for (const seat of defaultSeats) {
              await supabase.from('seats').insert([seat]);
            }
            const { data: newSeats } = await supabase.from('seats').select('*');
            seatsData = newSeats || [];
          }

          setSeats(seatsData);
          setCustomers(customersRes.data || []);
          setOrders(ordersRes.data || []);
          setVisits(visitsRes.data || []);
          setMenuItems(menuRes.data || []);
          setUsers(usersRes.data || []);
          setShiftRequests(shiftReqRes.data || []);

          // å–¶æ¥­æ—¥ã®çŠ¶æ…‹ã‚’è¨­å®š
          if (businessDaysRes.data) {
            setBusinessDay(businessDaysRes.data);
            setIsOpen(businessDaysRes.data.is_open);
          } else {
            setBusinessDay(null);
            setIsOpen(false);
          }

          setError(null);
        } catch (err) {
          setError('ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—: ' + err.message);
        }
        setLoading(false);
      };

      useEffect(() => { fetchData(); }, []);

      // é–‹åº—å‡¦ç†ï¼ˆå…¥ã‚Šï¼‰- ã‚¹ã‚¿ãƒƒãƒ•å‡ºå‹¤æƒ…å ±ä»˜ã
      const handleOpenBusiness = async (selectedStaff = []) => {
        const today = new Date().toISOString().split('T')[0];
        try {
          // å‡ºå‹¤ã‚¹ã‚¿ãƒƒãƒ•ã‚’ä¿å­˜
          setWorkingStaff(selectedStaff);

          // ã¾ãšä»Šæ—¥ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          const { data: existing } = await supabase.from('business_days').select('*').eq('business_date', today).single();

          if (existing) {
            // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯æ›´æ–°
            await supabase.from('business_days').update({
              opened_at: new Date().toISOString(),
              is_open: true,
              closed_at: null
            }).eq('business_date', today);
          } else {
            // æ–°è¦ä½œæˆ
            await supabase.from('business_days').insert([{
              business_date: today,
              opened_at: new Date().toISOString(),
              is_open: true
            }]);
          }
          await fetchData();
        } catch (err) {
          alert('é–‹åº—å‡¦ç†ã«å¤±æ•—: ' + err.message);
        }
      };

      // é–‰åº—å‡¦ç†ï¼ˆç· ã‚ï¼‰- ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      const handleCloseBusiness = () => {
        // æ®‹å®¢ãƒã‚§ãƒƒã‚¯
        const occupiedSeats = seats.filter(s => s.occupied);
        if (occupiedSeats.length > 0) {
          alert(`ã¾ã ${occupiedSeats.length}çµ„ã®ãŠå®¢æ§˜ãŒæ®‹ã£ã¦ã„ã¾ã™ã€‚\nå…¨å“¡é€€åº—å¾Œã«ç· ã‚ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚`);
          return;
        }

        // ä»Šæ—¥ã®å£²ä¸Šã‚’è¨ˆç®—
        const todayOrders = orders.filter(o => new Date(o.ordered_at).toDateString() === new Date().toDateString());
        const orderTotal = todayOrders.filter(o => !o.order_type || o.order_type === 'customer').reduce((sum, o) => sum + o.price, 0);
        const chargeTotal = todayOrders.filter(o => o.order_type === 'charge').reduce((sum, o) => sum + o.price, 0);
        const staffDrinkTotal = todayOrders.filter(o => o.order_type === 'staff_drink').reduce((sum, o) => sum + o.price, 0);
        const todayVisits = visits.filter(v => v.seated_at && new Date(v.seated_at).toDateString() === new Date().toDateString());
        const totalSales = orderTotal + chargeTotal + staffDrinkTotal;
        const totalCustomers = todayVisits.length;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
        setCloseData({
          orderTotal,
          chargeTotal,
          staffDrinkTotal,
          totalSales,
          totalCustomers
        });
        setShowCloseConfirm(true);
      };

      // å®Ÿéš›ã®ç· ã‚å‡¦ç†ã‚’å®Ÿè¡Œ
      const executeCloseBusiness = async () => {
        if (!closeData) return;
        const { totalSales, totalCustomers } = closeData;

        try {
          const today = new Date().toISOString().split('T')[0];
          await supabase.from('business_days').update({
            closed_at: new Date().toISOString(),
            is_open: false,
            total_sales: totalSales,
            total_customers: totalCustomers
          }).eq('business_date', today);
          await fetchData();
          setShowCloseConfirm(false);
          setCloseData(null);
          alert('æœ¬æ—¥ã®å–¶æ¥­ã‚’çµ‚äº†ã—ã¾ã—ãŸã€‚ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼');
        } catch (err) {
          alert('ç· ã‚å‡¦ç†ã«å¤±æ•—: ' + err.message);
          setShowCloseConfirm(false);
          setCloseData(null);
        }
      };

      const handleSelectSeat = (seat) => {
        setSelectedSeat(seat);
        if (!seat.occupied) setShowNewCustomer(true);
      };

      // è¤‡æ•°å¸­å¯¾å¿œï¼šseatIdsã¯é…åˆ—
      const handleNewCustomer = async (data, seatIds, partySize = 1) => {
        try {
          // seatIdsãŒé…åˆ—ã§ãªã„å ´åˆã¯é…åˆ—ã«å¤‰æ›ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
          const seatIdArray = Array.isArray(seatIds) ? seatIds : [seatIds];
          const primarySeatId = seatIdArray[0];

          const { data: newCust } = await supabase.from('customers').insert([data]);
          if (newCust?.[0]) {
            const { data: newVisit } = await supabase.from('visits').insert([{
              customer_id: newCust[0].id,
              seat_id: primarySeatId,
              is_active: true,
              party_size: partySize,
              seated_at: new Date().toISOString()
            }]);
            if (newVisit?.[0]) {
              // å…¨ã¦ã®å¸­ã‚’æ›´æ–°
              for (const sid of seatIdArray) {
                await supabase.from('seats').update({
                  occupied: true,
                  customer_id: newCust[0].id,
                  visit_id: newVisit[0].id,
                  seated_at: new Date().toISOString()
                }).eq('id', sid);
              }

              // åˆå›ãƒãƒ£ãƒ¼ã‚¸ã‚’æ³¨æ–‡ã¨ã—ã¦è¨˜éŒ²ï¼ˆ1æ™‚é–“åˆ†ï¼‰
              const chargeAmount = CHARGE_PER_HOUR * partySize;
              await supabase.from('orders').insert([{
                customer_id: newCust[0].id,
                seat_id: primarySeatId,
                visit_id: newVisit[0].id,
                item: `ãƒãƒ£ãƒ¼ã‚¸ 1hï¼ˆ${partySize}åï¼‰`,
                price: chargeAmount,
                order_type: 'charge'
              }]);
            }
          }
          await fetchData();
          setShowNewCustomer(false);
          setSelectedSeat(null);
        } catch (err) { alert('ç™»éŒ²å¤±æ•—'); }
      };

      // è¤‡æ•°å¸­å¯¾å¿œï¼šseatIdsã¯é…åˆ—
      const handleSelectExisting = async (customer, seatIds, partySize = 1) => {
        try {
          // seatIdsãŒé…åˆ—ã§ãªã„å ´åˆã¯é…åˆ—ã«å¤‰æ›ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
          const seatIdArray = Array.isArray(seatIds) ? seatIds : [seatIds];
          const primarySeatId = seatIdArray[0];

          console.log('ç€å¸­å‡¦ç†é–‹å§‹:', { customer: customer.name, seatIds: seatIdArray, partySize });

          // 1. æ¥åº—è¨˜éŒ²ã‚’ä½œæˆï¼ˆseated_atã‚’å«ã‚ã‚‹ï¼‰
          let newVisit, visitError;
          const now = new Date().toISOString();
          const visitData = {
            customer_id: customer.id,
            seat_id: primarySeatId,
            is_active: true,
            party_size: partySize,
            seated_at: now
          };

          const result1 = await supabase.from('visits').insert([visitData]);
          newVisit = result1.data;
          visitError = result1.error;

          // party_sizeã‚«ãƒ©ãƒ ãŒãªã„å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤
          if (visitError && visitError.includes('party_size')) {
            console.log('party_sizeãªã—ã§ãƒªãƒˆãƒ©ã‚¤');
            const result2 = await supabase.from('visits').insert([{
              customer_id: customer.id,
              seat_id: primarySeatId,
              is_active: true,
              seated_at: now
            }]);
            newVisit = result2.data;
            visitError = result2.error;
          }

          console.log('Visit insertçµæœ:', { newVisit, visitError });

          if (visitError) {
            alert('æ¥åº—è¨˜éŒ²ã®ä½œæˆã«å¤±æ•—: ' + visitError);
            return;
          }

          // 2. å…¨ã¦ã®å¸­ã‚’æ›´æ–°
          const seatUpdate = {
            occupied: true,
            customer_id: customer.id,
            visit_id: newVisit?.[0]?.id || null,
            seated_at: now
          };
          for (const sid of seatIdArray) {
            const { error: seatError } = await supabase.from('seats').update(seatUpdate).eq('id', sid);
            if (seatError) console.log('Seat update error for', sid, ':', seatError);
          }

          // 3. é¡§å®¢ã®æ¥åº—å›æ•°ã‚’æ›´æ–°
          await supabase.from('customers').update({
            total_visits: (customer.total_visits || 0) + 1,
            last_visit_at: now
          }).eq('id', customer.id);

          // 4. åˆå›ãƒãƒ£ãƒ¼ã‚¸ã‚’æ³¨æ–‡ã¨ã—ã¦è¨˜éŒ²ï¼ˆ1æ™‚é–“åˆ†ï¼‰
          const chargeAmount = CHARGE_PER_HOUR * partySize;
          await supabase.from('orders').insert([{
            customer_id: customer.id,
            seat_id: primarySeatId,
            visit_id: newVisit?.[0]?.id || null,
            item: `ãƒãƒ£ãƒ¼ã‚¸ 1hï¼ˆ${partySize}åï¼‰`,
            price: chargeAmount,
            order_type: 'charge'
          }]);

          console.log('ç€å¸­å‡¦ç†å®Œäº†ï¼ˆãƒãƒ£ãƒ¼ã‚¸è¨˜éŒ²æ¸ˆã¿ï¼‰');
          await fetchData();
          setShowNewCustomer(false);
          setSelectedSeat(null);
        } catch (err) {
          console.error('ç€å¸­ã‚¨ãƒ©ãƒ¼:', err);
          alert('ç€å¸­å¤±æ•—: ' + err.message);
        }
      };

      const handleAddOrder = async (data) => {
        await supabase.from('orders').insert([data]);
        await fetchData();
      };

      // æ³¨æ–‡å‰Šé™¤
      const handleDeleteOrder = async (orderId) => {
        await supabase.from('orders').delete().eq('id', orderId);
        await fetchData();
      };

      const handleUpdateCustomer = async (id, updates) => {
        await supabase.from('customers').update(updates).eq('id', id);
        await fetchData();
      };

      // ä¼šè¨ˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const handleCheckout = () => {
        if (!selectedSeat) return;
        const visit = visits.find(v => v.id === selectedSeat.visit_id);
        const visitOrders = orders.filter(o => o.visit_id === visit?.id);
        // æ³¨æ–‡åˆè¨ˆï¼ˆã‚ªãƒ¼ãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼‰
        const customerOrderTotal = visitOrders.filter(o => !o.order_type || o.order_type === 'customer').reduce((sum, o) => sum + o.price, 0);
        const staffDrinkTotal = visitOrders.filter(o => o.order_type === 'staff_drink').reduce((sum, o) => sum + o.price, 0);
        // ãƒãƒ£ãƒ¼ã‚¸ã‚‚ã‚ªãƒ¼ãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ã§è¨ˆç®—
        const chargeOrders = visitOrders.filter(o => o.order_type === 'charge');
        const chargeTotal = chargeOrders.reduce((sum, o) => sum + o.price, 0);
        const grandTotal = customerOrderTotal + chargeTotal + staffDrinkTotal;
        const partySize = visit?.party_size || 1;
        const chargeHours = chargeOrders.length;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆ
        setCheckoutData({
          visit,
          customerOrderTotal,
          chargeTotal,
          staffDrinkTotal,
          grandTotal,
          partySize,
          chargeHours,
          customerId: selectedSeat.customer_id
        });
        setShowCheckoutConfirm(true);
      };

      // å®Ÿéš›ã®ä¼šè¨ˆå‡¦ç†ã‚’å®Ÿè¡Œ
      const executeCheckout = async () => {
        if (!checkoutData) return;
        const { visit, grandTotal, customerId } = checkoutData;

        try {
          // æ¥åº—è¨˜éŒ²ã‚’æ›´æ–°
          if (visit) await supabase.from('visits').update({
            is_active: false,
            left_at: new Date().toISOString(),
            total_spent: grandTotal
          }).eq('id', visit.id);
          // é¡§å®¢ã®ç´¯è¨ˆã‚’æ›´æ–°
          const customer = customers.find(c => c.id === customerId);
          if (customer) {
            // æ›œæ—¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ›´æ–°
            const today = new Date().getDay();
            const pattern = customer.visit_pattern || {};
            pattern[today] = (pattern[today] || 0) + 1;
            await supabase.from('customers').update({
              total_spent: (customer.total_spent || 0) + grandTotal,
              visit_pattern: pattern
            }).eq('id', customer.id);
          }
          // åŒã˜visitã«ç´ã¥ãå…¨ã¦ã®å¸­ã‚’ãƒªã‚»ãƒƒãƒˆ
          const relatedSeats = seats.filter(s => s.visit_id === visit?.id);
          for (const s of relatedSeats) {
            await supabase.from('seats').update({ occupied: false, customer_id: null, visit_id: null, seated_at: null }).eq('id', s.id);
          }
          await fetchData();
          setShowCheckoutConfirm(false);
          setCheckoutData(null);
          setSelectedSeat(null);
        } catch (err) {
          alert('é€€åº—å¤±æ•—');
          setShowCheckoutConfirm(false);
          setCheckoutData(null);
        }
      };

      if (loading) return <div className="min-h-screen bg-slate-900 flex items-center justify-center text-white text-lg">èª­ã¿è¾¼ã¿ä¸­...</div>;
      if (error) return (
        <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl p-6 text-center">
            <p className="text-red-500 mb-4">{error}</p>
            <button onClick={fetchData} className="px-6 py-2 bg-blue-500 text-white rounded-xl">å†è©¦è¡Œ</button>
          </div>
        </div>
      );

      // é–‹åº—å‰ã¯æ“ä½œä¸å¯ - é–‹åº—ç”»é¢ã‚’è¡¨ç¤º
      if (!isOpen) {
        return <OpeningScreen onOpen={handleOpenBusiness} users={users} />;
      }

      if (selectedSeat?.occupied) {
        const customer = customers.find(c => c.id === selectedSeat.customer_id);
        const visit = visits.find(v => v.id === selectedSeat.visit_id);
        if (customer) return (
          <>
            <CustomerDetailPage customer={customer} seat={selectedSeat} visit={visit} orders={orders}
              onBack={() => setSelectedSeat(null)} onAddOrder={() => setShowAddOrder(true)}
              onEdit={() => setEditingCustomer(customer)} onCheckout={handleCheckout} onRefresh={fetchData} currentTime={currentTime}
              onDeleteOrder={handleDeleteOrder} />
            {showAddOrder && <AddOrderModal customer={customer} seatId={visit?.seat_id || selectedSeat.id} visitId={visit?.id} menuItems={menuItems} users={users} workingStaff={workingStaff}
              onClose={() => setShowAddOrder(false)} onSave={handleAddOrder} />}
            {editingCustomer && <CustomerDetailModal customer={editingCustomer} onClose={() => setEditingCustomer(null)} onSave={handleUpdateCustomer} />}
            {showCheckoutConfirm && <CheckoutConfirmModal data={checkoutData} onConfirm={executeCheckout} onCancel={() => { setShowCheckoutConfirm(false); setCheckoutData(null); }} />}
            <NavBar currentPage={currentPage} onNavigate={(p) => { setCurrentPage(p); setSelectedSeat(null); }} />
          </>
        );
      }

      return (
        <>
          {currentPage === 'floor' && <FloorMapPage seats={seats} customers={customers} orders={orders} visits={visits} users={users} onSelectSeat={handleSelectSeat} onRefresh={fetchData} currentTime={currentTime} />}
          {currentPage === 'dashboard' && <DashboardPage orders={orders} visits={visits} customers={customers} onRefresh={fetchData} />}
          {currentPage === 'staff' && <StaffSalesPage orders={orders} users={users} onRefresh={fetchData} />}
          {currentPage === 'shift' && <ShiftPage users={users} shiftRequests={shiftRequests} workingStaff={workingStaff} setWorkingStaff={setWorkingStaff} onRefresh={fetchData} />}
          {currentPage === 'customers' && <CustomersPage customers={customers} orders={orders} onRefresh={fetchData} onEditCustomer={(c) => setEditingCustomer(c)} />}
          {currentPage === 'settings' && <SettingsPage seats={seats} menuItems={menuItems} users={users} workingStaff={workingStaff} setWorkingStaff={setWorkingStaff} onRefresh={fetchData} onCloseBusiness={handleCloseBusiness} businessDay={businessDay} />}

          {showNewCustomer && selectedSeat && (
            <NewCustomerModal seat={selectedSeat} initialName="" customers={customers} allSeats={seats}
              onClose={() => { setShowNewCustomer(false); setSelectedSeat(null); }}
              onSave={handleNewCustomer} onSelectExisting={handleSelectExisting} />
          )}
          {editingCustomer && <CustomerDetailModal customer={editingCustomer} onClose={() => setEditingCustomer(null)} onSave={handleUpdateCustomer} />}
          {showCloseConfirm && <CloseConfirmModal data={closeData} onConfirm={executeCloseBusiness} onCancel={() => { setShowCloseConfirm(false); setCloseData(null); }} />}
          <NavBar currentPage={currentPage} onNavigate={setCurrentPage} />
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
